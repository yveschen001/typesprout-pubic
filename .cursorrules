# TypeSprout .cursorrules

project:
  name: "TypeSprout â€” Kids Typing & Tree Growth"
  versioning:
    - Bump minor on feature, patch on fix; reflect in README
  locale: zh-TW

runtime:
  node: "22.x"           # use .nvmrc
  packageManager: npm
  react: "18.3.x"
  vite: "7.x"
  tailwind: "4 + @tailwindcss/vite"
  typescript: strict
  testing: ["vitest", "@testing-library/react", "playwright"]

routing_i18n:
  baseRoute: "/{lang}/..."
  supportedLangs: ["zh-TW","zh-CN","en-US"]
  router: react-router-dom@7
  i18n: i18next + react-i18next
  redirect:
    - Missing/invalid lang -> navigator.language or fallback en-US

structure:
  src/app: [main.tsx, routes]
  src/libs: [firebase.ts, i18n.ts]
  src/features: [auth, typing, leaderboard, gamification, profile, garden]
  src/pages: [Home, Practice, Test, Result, Leaderboard, Profile, Garden, Admin]
  src/components: [Button, Card, Field]
  scripts: [gen-sitemap-robots.mjs]
  public: static assets

editing_rules:
  - Prefer editing existing files over adding new ones
  - Keep related logic in features/* modules
  - No random demo/test/log files
  - Create new files only when existing file becomes too large
  - Never create new .env files - use existing .env files only
  - Do not modify or create environment variable files without explicit user request

env_variables:
  required:
    - VITE_FIREBASE_API_KEY
    - VITE_FIREBASE_AUTH_DOMAIN
    - VITE_FIREBASE_PROJECT_ID
    - VITE_FIREBASE_STORAGE_BUCKET
    - VITE_FIREBASE_MESSAGING_SENDER_ID
    - VITE_FIREBASE_APP_ID
    - VITE_FIREBASE_MEASUREMENT_ID (optional)
    - VITE_ADS_ENABLED=false
    - VITE_SHEETS_CONTENT_URL (optional)
    - VITE_SHEETS_COUNTERS_URL (optional)
    - VITE_USE_GA=false
    - VITE_USE_CF=false
  usage:
    - Initialize Firebase via src/libs/firebase.ts only

firebase:
  auth: Google only
  models_required:
    - profiles, attempts, leaderboards, trees, inventory, harvests, economyLogs, dailyProgress
  rules_summary:
    - attempts.create: auth && uid==auth.uid && durationSec>=30 && 0<=accuracy<=1
    - leaderboards: public read
    - others: user can read/write own docs only
  indexes_recommended:
    - attempts: (lang ASC, ts DESC), (uid ASC, ts DESC)
    - leaderboards: (period ASC, lang ASC, scopeId ASC)
    - economyLogs: (uid ASC, ts DESC)
    - attempts: (lang ASC, adjWpm DESC, ts DESC)

typing_scoring:
  formulas:
    - en.rawWPM=(chars/5)/minutes
    - zh.CPM=chineseChars/minutes; UI shows WPM(zh)=CPM
    - accuracy=correctChars/totalQuestionChars; adjusted=correctChars/minutes (æ­£ç¢ºé€Ÿåº¦)
    - é€Ÿåº¦è¨ˆç®—ï¼šåŸºæ–¼å¯¦éš›æ‰“å‡ºçš„æ­£ç¢ºå­—æ•¸ Ã· æ™‚é–“
    - æ­£ç¢ºç‡è¨ˆç®—ï¼šæ­£ç¢ºå­—æ•¸ Ã· é¡Œç›®ç¸½å­—æ•¸
    - ç¶œåˆåˆ†æ•¸ï¼šå°±æ˜¯æ­£ç¢ºé€Ÿåº¦ï¼Œä¸éœ€è¦å†ä¹˜ä»¥æ­£ç¢ºç‡
  anti_cheat:
    - duration<30s: skip write/EP/leaderboard
    - extreme: en>200 WPM or zh>400 CPM filtered
    - no paste; backspace toggle allowed
  stabilization:
    - score = mean(winsorize(last10.adjWpm, 5/95))
  ime:
    - Only count characters on compositionend for CJK IME
  time_calculation:
    - æ¯é¡Œç¨ç«‹è¨ˆæ™‚ï¼šå¾ç„¦é»é€²å…¥è¼¸å…¥æ¡†é–‹å§‹ï¼Œåˆ°æŒ‰ä¸‹é€å‡ºçµæŸ
    - æ‰€æœ‰é¡Œç›®çš„æ™‚é–“ç´¯åŠ ç‚ºç¸½æ™‚é–“
    - ç¢ºä¿åªè¨ˆç®—å¯¦éš›ç­”é¡Œæ™‚é–“ï¼Œä¸åŒ…æ‹¬æ€è€ƒæˆ–æš«åœæ™‚é–“
    - ä½¿ç”¨ performance.now() é€²è¡Œé«˜ç²¾åº¦è¨ˆæ™‚

garden_economy:
  config:
    - base(lang)=10; dailyEPcap=200
    - targets: en G1..G6=10..35; zh G1..G6=60..120
    - stages: S2â‰¥100, S3â‰¥300, S4â‰¥700, S5â‰¥1200
  formulas:
    - EP=base*minutes*clamp(adj/target,0,2)*(0.5+0.5*acc)
    - GP=EP*(1+0.2*fertilizerToday+0.1*waterToday)
    - fruits=floor((dailyGP/200)*(1+min(streakDays/7*0.1,0.3)))

seo_performance:
  - Use react-helmet-async for page <title>/<meta>
  - Generate sitemap.xml & robots.txt via scripts/gen-sitemap-robots.mjs
  - Output hreflang alternates and canonical per language page
  - Inject JSON-LD (SoftwareApplication/LearningResource) per route
  - /admin must use meta robots noindex,nofollow
  - Lighthouse mobile â‰¥ 90; FCP < 2.5s; gzip bundle < 300KB

ui_guidelines:
  path: docs/ui-guidelines.md
  enforce: true
  tokens:
    colors:
      primary: "#16a34a"     # green-600
      primary-foreground: "#ffffff"
      secondary: "#0ea5e9"   # sky-500
      accent: "#f97316"      # orange-500
      success: "#16a34a"
      warning: "#f59e0b"
      danger: "#ef4444"
      surface: "#ffffff"
      surface-foreground: "#111827"
      muted: "#6b7280"
      border: "#e5e7eb"
    radius:
      sm: 8
      md: 12
      lg: 16
    elevation:
      card: "0 1px 2px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.04)"
    focus:
      ring: "2px solid #38bdf8"
    motion:
      prefersReducedMotion: respect
  typing_page_principles:
    - Minimal & focused like Monkeytype; non-blocking UI
    - Realtime feedback: per-char highlight (correct/incorrect/current)
    - Countdown emphasis: big timer, <=10s turns warning color
    - Sticky shortcuts bar: Space start/pause, R reset, F focus
    - Paste disabled prompt; backspace toggle visible
    - CapsLock & out-of-focus warnings; aria-live updates
    - Performance-friendly; respect prefers-reduced-motion
    - Insights é è¨­æ”¶èµ·ï¼›æ¡å–®ç·šåœ–ï¼ˆé€Ÿåº¦=ç¶ ã€æ­£ç¢ºç‡=è—ï¼‰
    - åœ–ä¸ŠåŠ è¨»è§£ï¼šã€é€™è£¡æœ€é«˜ã€èˆ‡ã€æœ€è¿‘ï¼ˆâ†‘/â†“ï¼‰ã€ä¸¦é¡¯ç¤ºæ•¸å€¼
    - ç‚ºåœ–èˆ‡å€å¡Šæä¾› aria-label / aria-describedby èˆ‡ç°¡çŸ­åœ–ä¾‹æ–‡å­—ï¼ˆå…’ç«¥å¯ç†è§£ï¼‰
    - æä¾›ã€Œå°å¹«æ‰‹ã€æŒ‰éˆ•ï¼šé–‹å•Ÿå¯å­˜å–å°è©±æ¡†ï¼Œç”¨æ·ºç™½èªè¨€è§£é‡‹åœ–è¡¨èˆ‡å­¸ç¿’å»ºè­°
    - èªè¨€åˆ‡æ›æ”¾åœ¨ Profileï¼›Header ä¸å†é¡¯ç¤ºå¿«é€Ÿåˆ‡æ›

code_style:
  - Clean names; guard clauses; no empty catch
  - Comments explain why; avoid TODO
  - Keep formatting consistent; do not reformat unrelated code
  - Validate external data with Zod schemas in adapters/*

git:
  branches: [feat/*, fix/*, chore/*, docs/*]
  commits: Conventional Commits
  pr_checklist:
    - Vitest unit tests pass
    - Playwright e2e happy path passes
  backup_push:
    remotes:
      private: origin   # https://github.com/yveschen001/typesprout
      public: public    # https://github.com/yveschen001/typesprout-pubic
    rules:
      - Never push secrets to public (dotenv/.env*, service keys). Already ignored by .gitignore
      - Public push is only executed on explicit user command
    commands:
      private_push: git push origin main
      public_push: git push public main

dev_commands:
  - nvm use 22
  - npm run dev
  - npm run build
  - SITE_BASE=https://<domain> node scripts/gen-sitemap-robots.mjs
  - git push origin main   # ç§åº«ï¼ˆprivateï¼‰
  - git push public main   # å…¬åº«ï¼ˆpublicï¼Œtypesprout-pubicï¼‰
  - npm run deploy:private  # æœ¬åœ°å»ºç½® â†’ æ¨ dist åˆ° origin:gh-pages
  - npm run deploy:public   # æœ¬åœ°å»ºç½®ï¼ˆSITE_BASE=https://typesprout.comï¼ŒPUBLIC_BASE=/ï¼Œå« CNAMEï¼‰â†’ æ¨ dist åˆ° public:gh-pages

references:
  - react-router v7: "https://reactrouter.com/"
  - i18next/react-i18next:
    - "https://www.i18next.com/"
    - "https://react.i18next.com/"
  - MDN BCP-47 language tags: "https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/lang#language_tags_in_html"
  - Firebase:
    - Web setup: "https://firebase.google.com/docs/web/setup"
    - Google Sign-In: "https://firebase.google.com/docs/auth/web/google-signin"
    - Firestore rules: "https://firebase.google.com/docs/firestore/security/get-started"
  - Tailwind v4 + @tailwindcss/vite: "https://tailwindcss.com/docs/installation/using-vite"
  - Lighthouse performance targets: "https://web.dev/fast/"
  - JSON-LD:
    - SoftwareApplication: "https://schema.org/SoftwareApplication"
    - LearningResource: "https://schema.org/LearningResource"
  - UI Guidelines (æœ¬å°ˆæ¡ˆ): "docs/ui-guidelines.md"

dns_pages:
  domain: typesprout.com
  provider: GitHub Pages
  steps:
    - åœ¨å…¬åº« `typesprout-pubic` çš„ Pages è¨­å®šè‡ªè¨‚ç¶²åŸŸå¡«å…¥ `typesprout.com`
    - åœ¨ DNS è¨­å®šï¼š
      - A è¨˜éŒ„ â†’ 185.199.108.153 / 185.199.109.153 / 185.199.110.153 / 185.199.111.153
      -ï¼ˆå¯é¸ï¼‰åŠ ä¸€å€‹ `www` çš„ CNAME æŒ‡å‘ `yveschen001.github.io`
    - ä½ˆç½²æµç¨‹æœƒè‡ªå‹•åœ¨ gh-pages ç”¢å‡º `CNAME` æª”ï¼Œå…§å®¹ç‚º `typesprout.com`
    - è®Šæ›´ DNS å¾Œï¼Œç­‰å¾…ç”Ÿæ•ˆï¼ˆé€šå¸¸æ•¸åˆ†é˜è‡³ 24 å°æ™‚ï¼‰

adaptive_typing:
  enabled: true
  sources:
    - content/en/ngrams.json
    - content/zh/common.json
  behavior:
    - key-weight: w(key)=baseFreq*(1+alpha*errRate)*(1+beta*latencyZ)
    - alpha: 0.8
    - beta: 0.3
    - english: avoid 3 same letters; insert bigrams occasionally
    - chinese: compose 2â€“4 char chunks from common set
    - after-segment: slightly decay weights for recently successful keys

heatmap_charts:
  keyboard: layout=['qwerty','bopomofo'], color=errRate, highlight=nextKey
  charts: Speed(å–®ç·š adjï¼Œå«æœ€é«˜/æœ€è¿‘è¨»è¨˜), Accuracy(å–®ç·š)

analytics_privacy:
  ga4:
    consent: { ad_storage: denied, ad_user_data: denied, ad_personalization: denied }
    signals: { allow_google_signals: false, allow_ad_personalization_signals: false, ads_data_redaction: true }
  cloudflare: allowed
  mutually_exclusive: true
  toggles:
    - VITE_USE_GA=true -> load GA4 with Consent Mode defaults
    - VITE_USE_CF=true -> load Cloudflare Web Analytics
    - if both true -> warn and prefer GA4

timezone_handling:
  global_compatibility: true
  principles:
    - All date/time calculations must consider global users in different timezones
    - Use local time for user-facing displays and calculations
    - Use UTC for Firebase queries and data storage
    - Convert between timezones explicitly, never assume
  best_practices:
    - date_calculation:
      - Use `new Date().toLocaleDateString('en-CA')` for YYYY-MM-DD format in user's timezone
      - Use `Intl.DateTimeFormat().resolvedOptions().timeZone` to detect user's timezone
      - Use `Date.UTC()` only when creating UTC timestamps for Firebase queries
    - firebase_queries:
      - Store timestamps in UTC (Firebase default)
      - Query with UTC time ranges using `Timestamp.fromDate(Date.UTC(...))`
      - Convert results to local time for display using `toLocaleDateString()`
    - date_comparison:
      - Convert UTC timestamps to local date strings before comparing
      - Use `timestamp.toLocaleDateString('en-CA')` for consistent YYYY-MM-DD format
      - Never use `toISOString().slice(0,10)` for date comparison (UTC only)
    - examples:
      - correct: "const today = new Date().toLocaleDateString('en-CA')"
      - correct: "const localDate = utcTimestamp.toLocaleDateString('en-CA')"
      - correct: "const utcStart = Date.UTC(year, month, day, 0, 0, 0)"
      - wrong: "const date = timestamp.toISOString().slice(0,10)" # UTC only
      - wrong: "const today = new Date().toISOString().slice(0,10)" # UTC only
  affected_features:
    - Today's progress calculation (Layout.tsx)
    - Garden page today summary (Garden.tsx)
    - Leaderboard daily/weekly/monthly filtering
    - Recent activity computation (garden/api.ts)
    - All date-based data filtering and aggregation

# ğŸ›¡ï¸ CRITICAL: Code Protection Rules
code_protection:
  # åœ¨ä¿®æ”¹ä»»ä½•ç°æœ‰åŠŸèƒ½ä¹‹å‰ï¼Œå¿…é¡»å…ˆè¿›è¡Œä»¥ä¸‹æ£€æŸ¥
  before_modification:
    - 1. ç¡®è®¤å½“å‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œ
    - 2. è¯†åˆ«æ‰€æœ‰ç›¸å…³çš„æ–‡ä»¶å’Œå‡½æ•°
    - 3. ç†è§£æ•°æ®æµå’Œä¾èµ–å…³ç³»
    - 4. åˆ¶å®šæœ€å°åŒ–ä¿®æ”¹è®¡åˆ’
    - 5. å¤‡ä»½å…³é”®ä»£ç æ®µ
  
  # ä¿®æ”¹è¿‡ç¨‹ä¸­çš„ä¿æŠ¤æªæ–½
  during_modification:
    - åªä¿®æ”¹æ˜ç¡®éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†
    - ä¿æŒç°æœ‰APIå’Œæ¥å£ä¸å˜
    - æ·»åŠ è°ƒè¯•æ—¥å¿—è€Œä¸æ˜¯åˆ é™¤ç°æœ‰æ—¥å¿—
    - ä½¿ç”¨æ¸è¿›å¼ä¿®æ”¹ï¼Œä¸€æ¬¡åªæ”¹ä¸€ä¸ªåŠŸèƒ½
    - æ¯æ¬¡ä¿®æ”¹åç«‹å³æµ‹è¯•ç›¸å…³åŠŸèƒ½
  
  # ç¦æ­¢çš„æ“ä½œ
  forbidden_operations:
    - ä¸è¦é‡æ„å·²ç»æ­£å¸¸å·¥ä½œçš„ä»£ç 
    - ä¸è¦åˆ é™¤ç°æœ‰çš„è°ƒè¯•ä¿¡æ¯
    - ä¸è¦æ”¹å˜ç°æœ‰çš„æ•°æ®ç»“æ„å’Œæ¥å£
    - ä¸è¦åŒæ—¶ä¿®æ”¹å¤šä¸ªä¸ç›¸å…³çš„åŠŸèƒ½
    - ä¸è¦å‡è®¾ä»£ç çš„ç”¨é€”ï¼Œå¿…é¡»å…ˆç†è§£
  
  # å¿…é¡»ä¿æŠ¤çš„æ ¸å¿ƒåŠŸèƒ½
  protected_features:
    - å›¾è¡¨æ•°æ®æ˜¾ç¤º (SpeedChart.tsx, AccuracyChart.tsx)
    - æœ€è¿‘è®°å½•æ˜¾ç¤º (Garden.tsx, recentEconomyLogs)
    - ä»Šæ—¥è¿›åº¦è®¡ç®— (Layout.tsx)
    - æ‰“å­—æµ‹è¯•æ ¸å¿ƒé€»è¾‘ (Test.tsx)
    - æ•°æ®æŒä¹…åŒ– (applyAttemptRewards)
  
  # ä¿®æ”¹åçš„éªŒè¯æ­¥éª¤
  after_modification:
    - 1. æµ‹è¯•è¢«ä¿®æ”¹çš„åŠŸèƒ½
    - 2. æµ‹è¯•ç›¸å…³çš„ä¾èµ–åŠŸèƒ½
    - 3. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
    - 4. éªŒè¯æ•°æ®æµæ˜¯å¦æ­£å¸¸
    - 5. ç¡®è®¤ç”¨æˆ·ç•Œé¢æ˜¾ç¤ºæ­£ç¡®

# ğŸš¨ ç´§æ€¥ä¿®å¤æŒ‡å—
emergency_fixes:
  # å¦‚æœç ´åäº†ç°æœ‰åŠŸèƒ½ï¼Œç«‹å³æ‰§è¡Œä»¥ä¸‹æ­¥éª¤
  immediate_actions:
    - 1. åœæ­¢æ‰€æœ‰ä¿®æ”¹
    - 2. ä½¿ç”¨ git status æ£€æŸ¥ä¿®æ”¹çš„æ–‡ä»¶
    - 3. ä½¿ç”¨ git diff æŸ¥çœ‹å…·ä½“ä¿®æ”¹å†…å®¹
    - 4. ä½¿ç”¨ git restore æ¢å¤è¢«ç ´åçš„æ–‡ä»¶
    - 5. é‡æ–°å¼€å§‹ï¼Œä½¿ç”¨æ›´å°å¿ƒçš„æ–¹å¼ä¿®æ”¹
  
  # æ¢å¤ç­–ç•¥
  recovery_strategy:
    - ä¼˜å…ˆæ¢å¤ç”¨æˆ·å¯è§çš„åŠŸèƒ½
    - ä¿æŒæ•°æ®å®Œæ•´æ€§
    - ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸å·¥ä½œ
    - é€æ­¥ä¿®å¤æ¬¡è¦åŠŸèƒ½
    - æœ€åä¼˜åŒ–å’Œæ¸…ç†ä»£ç 

# ğŸ¯ æœ€ä½³å¯¦è¸æ–¹æ¡ˆ (v1.3.0 å„ªåŒ–æˆæœ)
best_practices:
  # åˆ†é˜æ•¸è¨ˆç®—ä¸€è‡´æ€§
  minute_calculation_consistency:
    principle: "Layoutå’ŒGardené é¢å¿…é ˆé¡¯ç¤ºç›¸åŒçš„é ä¼°åˆ†é˜æ•¸"
    implementation:
      - ä½¿ç”¨ç›¸åŒçš„éŒ¯èª¤è™•ç†é‚è¼¯ï¼šæª¢æŸ¥ epPerMin æ˜¯å¦ç‚ºæœ‰æ•ˆæ•¸å­—
      - è¨­ç½®åˆç†çš„ä¸Šé™é™åˆ¶ï¼šæœ€å¤§100åˆ†é˜
      - ç„¡æ•ˆæ™‚è¿”å› null è€Œä¸æ˜¯éŒ¯èª¤å€¼
      - çµ±ä¸€çš„è¨ˆç®—å…¬å¼ï¼šNumber((sec / 60).toFixed(2))
    code_example: |
      if (!Number.isFinite(epPerMin) || epPerMin <= 0) {
        setEstMinLeft(null)
      } else {
        const mins = remain <= 0 ? 0 : Math.ceil(remain / epPerMin)
        const maxMins = 100
        const finalMins = Math.min(mins, maxMins)
        setEstMinLeft(Number.isFinite(finalMins) ? finalMins : null)
      }

  # æœ‰æ•ˆè¼¸å…¥åˆ†é˜æ•¸ç²¾åº¦
  effective_input_precision:
    principle: "ä¿ç•™å°æ•¸é»å¾Œå…©ä½ç²¾åº¦ï¼Œæä¾›æ›´æº–ç¢ºçš„æ•¸æ“šé¡¯ç¤º"
    implementation:
      - ä½¿ç”¨ Number((sec / 60).toFixed(2)) è€Œé Math.floor(sec / 60)
      - èƒ½æ­£ç¢ºé¡¯ç¤ºå°æ–¼1åˆ†é˜çš„ç·´ç¿’æ™‚é–“
      - èˆ‡é ä¼°æ™‚é–“è¨ˆç®—é‚è¼¯ä¿æŒä¸€è‡´
    code_example: |
      const minutes = Number((sec / 60).toFixed(2)) // ä¿ç•™å°æ•¸é»å¾Œå…©ä½
      const active = minutes > 0

  # éŒ¯èª¤è™•ç†å’Œå›é€€æ©Ÿåˆ¶
  error_handling_fallback:
    principle: "å¯¦ç¾å®Œæ•´çš„éŒ¯èª¤è™•ç†å’Œå›é€€æ©Ÿåˆ¶ï¼Œç¢ºä¿ç³»çµ±ç©©å®šæ€§"
    implementation:
      - è¤‡åˆæŸ¥è©¢å¤±æ•—æ™‚è‡ªå‹•å›é€€åˆ°ç°¡å–®æŸ¥è©¢
      - æ‰€æœ‰æŸ¥è©¢éƒ½å¤±æ•—æ™‚è¿”å›é»˜èªå€¼
      - è©³ç´°çš„èª¿è©¦æ—¥èªŒä¾¿æ–¼å•é¡Œæ’æŸ¥
      - é¿å…ç³»çµ±å´©æ½°ï¼Œæä¾›é™ç´šæœå‹™
    code_example: |
      try {
        // æ–¹æ¡ˆ1ï¼šè¤‡åˆæŸ¥è©¢ï¼ˆéœ€è¦ç´¢å¼•ï¼‰
        const q = query(collection(db, 'attempts'), ...)
        // ... è™•ç†é‚è¼¯
      } catch (error) {
        console.warn('Composite query failed, falling back to simple query:', error)
        try {
          // æ–¹æ¡ˆ2ï¼šç°¡å–®æŸ¥è©¢ï¼ˆä¸éœ€è¦ç´¢å¼•ï¼‰
          const q = query(collection(db, 'attempts'), ...)
          // ... è™•ç†é‚è¼¯
        } catch (fallbackError) {
          console.error('Both queries failed:', fallbackError)
          return { days: defaultDays, activeDays: 0 }
        }
      }

  # æ™‚å€è™•ç†ä¸€è‡´æ€§
  timezone_consistency:
    principle: "æ‰€æœ‰æ—¥æœŸè¨ˆç®—å¿…é ˆè€ƒæ…®å…¨çƒç”¨æˆ¶çš„ä¸åŒæ™‚å€"
    implementation:
      - ç”¨æˆ¶é¡¯ç¤ºä½¿ç”¨æœ¬åœ°æ™‚é–“ï¼štoLocaleDateString('en-CA')
      - FirebaseæŸ¥è©¢ä½¿ç”¨UTCæ™‚é–“ï¼šTimestamp.fromDate(Date.UTC(...))
      - æ—¥æœŸæ¯”è¼ƒçµ±ä¸€ä½¿ç”¨æœ¬åœ°æ™‚é–“æ ¼å¼
      - é¿å…ä½¿ç”¨ toISOString().slice(0,10) é€²è¡Œæ—¥æœŸæ¯”è¼ƒ
    code_example: |
      // æ­£ç¢ºï¼šä½¿ç”¨æœ¬åœ°æ™‚é–“
      const today = new Date().toLocaleDateString('en-CA')
      const localDate = utcTimestamp.toLocaleDateString('en-CA')
      
      // éŒ¯èª¤ï¼šä½¿ç”¨UTCæ™‚é–“
      const today = new Date().toISOString().slice(0,10) // UTC only

  # æ•¸æ“šæºçµ±ä¸€æ€§
  data_source_unification:
    principle: "ç›¸åŒåŠŸèƒ½çš„æ•¸æ“šæºå¿…é ˆçµ±ä¸€ï¼Œé¿å…ä¸ä¸€è‡´"
    implementation:
      - Homeå’ŒGardené é¢çš„æ¨¹çµ„ä»¶ä½¿ç”¨ç›¸åŒçš„ loadGarden æ•¸æ“šæº
      - é¿å…ä½¿ç”¨ä¸åŒçš„hookæˆ–APIç²å–ç›¸åŒæ•¸æ“š
      - ç¢ºä¿æ•¸æ“šæ›´æ–°æ™‚æ‰€æœ‰ç›¸é—œçµ„ä»¶åŒæ­¥æ›´æ–°
    code_example: |
      // çµ±ä¸€ä½¿ç”¨ loadGarden è€Œé usePlantLevel
      const gardenData = await loadGarden(user.uid)
      const stage = Number(gardenData.tree?.stage || 1)

  # é¡Œåº«åŠ è¼‰å„ªåŒ–
  question_bank_optimization:
    principle: "æ™ºèƒ½åŠ è¼‰ç­–ç•¥ï¼Œå¹³è¡¡æ€§èƒ½å’Œç”¨æˆ¶é«”é©—"
    implementation:
      - åˆå§‹è¼‰å…¥3é ï¼ŒèƒŒæ™¯é è¼‰å‰©é¤˜é é¢
      - æ™ºèƒ½æ¸¸æ¨™ç®¡ç†ï¼ŒFirebaseåŒæ­¥é€²åº¦
      - 80%å®Œæˆåº¦æ™‚é‡ç½®æ¸¸æ¨™ï¼Œç¢ºä¿å®Œæ•´å¾ªç’°
      - éŒ¯èª¤è™•ç†å’Œå›é€€æ©Ÿåˆ¶
    code_example: |
      // å‹•æ…‹æ§åˆ¶æŠ“å–ä¸Šé™
      const dynamicLimit = Math.min(200, Math.max(numQuestions * 4, 60))
      // èƒŒæ™¯çºŒè¼‰
      setTimeout(() => {
        fetchContent({ lang, limit: 200, startPage: nextStart, pageCount: 2 })
      }, 0)

  # UIçµ„ä»¶ä¸€è‡´æ€§
  ui_component_consistency:
    principle: "ç›¸åŒåŠŸèƒ½çš„UIçµ„ä»¶å¿…é ˆä¿æŒä¸€è‡´çš„æ¨£å¼å’Œè¡Œç‚º"
    implementation:
      - çµ±ä¸€çš„Tooltipæ¨£å¼å’Œä½ç½®
      - ä¸€è‡´çš„è¼‰å…¥ç‹€æ…‹å’ŒéŒ¯èª¤è™•ç†
      - ç›¸åŒçš„æ•¸æ“šé¡¯ç¤ºæ ¼å¼å’Œç²¾åº¦
      - çµ±ä¸€çš„é¡è‰²å’Œé–“è·è¦ç¯„
    code_example: |
      // çµ±ä¸€çš„Tooltipå¯¦ç¾
      <Tooltip label="è©³ç´°èªªæ˜æ–‡å­—">ï¼Ÿ</Tooltip>
      
      // çµ±ä¸€çš„è¼‰å…¥ç‹€æ…‹
      {loading && <div className="text-center py-8">è¼‰å…¥ä¸­...</div>}
      {error && <div className="text-center py-8 text-red-600">{error}</div>}

  # æ€§èƒ½å„ªåŒ–ç­–ç•¥
  performance_optimization:
    principle: "åœ¨ä¿è­‰åŠŸèƒ½çš„å‰æä¸‹å„ªåŒ–æ€§èƒ½"
    implementation:
      - ä½¿ç”¨ onSnapshot é€²è¡Œå¯¦æ™‚æ•¸æ“šæ›´æ–°
      - å¯¦ç¾æ™ºèƒ½é è¼‰å’Œç·©å­˜æ©Ÿåˆ¶
      - é¿å…ä¸å¿…è¦çš„é‡è¤‡æŸ¥è©¢
      - åˆç†ä½¿ç”¨ limit é™åˆ¶æŸ¥è©¢æ•¸é‡
    code_example: |
      // å¯¦æ™‚ç›£è½æ•¸æ“šè®ŠåŒ–
      const unsub = onSnapshot(q, (snaps) => {
        // è™•ç†æ•¸æ“šæ›´æ–°
      })
      
      // æ™ºèƒ½é è¼‰
      if (remain <= THRESH && !prefetchingRef.current) {
        prefetchingRef.current = true
        // èƒŒæ™¯é è¼‰é‚è¼¯
      }

  # æ™‚é–“è¨ˆç®—æº–ç¢ºæ€§
  time_calculation_accuracy:
    principle: "ç¢ºä¿æ™‚é–“è¨ˆç®—çš„æº–ç¢ºæ€§å’Œä¸€è‡´æ€§"
    implementation:
      - æ¯é¡Œç¨ç«‹è¨ˆæ™‚ï¼šå¾ç„¦é»é€²å…¥è¼¸å…¥æ¡†é–‹å§‹ï¼Œåˆ°æŒ‰ä¸‹é€å‡ºçµæŸ
      - æ‰€æœ‰é¡Œç›®çš„æ™‚é–“ç´¯åŠ ç‚ºç¸½æ™‚é–“
      - ç¢ºä¿åªè¨ˆç®—å¯¦éš›ç­”é¡Œæ™‚é–“ï¼Œä¸åŒ…æ‹¬æ€è€ƒæˆ–æš«åœæ™‚é–“
      - ä½¿ç”¨ performance.now() é€²è¡Œé«˜ç²¾åº¦è¨ˆæ™‚
      - é€Ÿåº¦è¨ˆç®—åŸºæ–¼å¯¦éš›æ‰“å‡ºçš„æ­£ç¢ºå­—æ•¸ï¼Œä¸æ˜¯é¡Œç›®ç¸½å­—æ•¸
      - æ­£ç¢ºç‡è¨ˆç®—åŸºæ–¼é¡Œç›®ç¸½å­—æ•¸ï¼Œæœªè¼¸å…¥éƒ¨åˆ†ç®—ä½œéŒ¯èª¤
    code_example: |
      // æ­£ç¢ºçš„æ™‚é–“è¨ˆç®—é‚è¼¯
      const accuracy = totalCorrectAll / totalQCharsAll // æ­£ç¢ºå­—æ•¸ Ã· é¡Œç›®ç¸½å­—æ•¸
      const rawBase = isZhTyping ? (totalCorrectAll / minutes) : ((totalCorrectAll / 5) / minutes)
      const adjWpm = rawBase // ç¶œåˆåˆ†æ•¸å°±æ˜¯æ­£ç¢ºé€Ÿåº¦ï¼Œä¸éœ€è¦å†ä¹˜ä»¥æ­£ç¢ºç‡
      
      // æ¯é¡Œç¨ç«‹è¨ˆæ™‚
      const qStartTime = performance.now()
      // ... ç­”é¡Œéç¨‹
      const qElapsedMs = performance.now() - qStartTime
      totalEffectiveMs += qElapsedMs