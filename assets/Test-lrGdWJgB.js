const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Result-B47avcVM.js","assets/index-D4RQrBUQ.js","assets/index-ltVW486p.css","assets/ChartSection-x7vIRUtL.js","assets/index-eKjPdLg9.js"])))=>i.map(i=>d[i]);
import{j as s,r as t,f as Ae,e as D,q as ot,w as Re,o as ct,n as kt,i as it,H as Yt,d as z,g as we,t as me,m as pe,h as Dt,u as ys,y as xs,b as Ss,c as bs,_ as Zt,k as At,I as ws,J as vs,B as st}from"./index-D4RQrBUQ.js";import{C as Ms,S as Ns,A as Cs}from"./ChartSection-x7vIRUtL.js";import{u as js,a as Et}from"./useQuestionBank-uJQo5RO7.js";import{d as Ts}from"./debug-CNNn05X7.js";import{g as Rs}from"./index-eKjPdLg9.js";import"./env-BTJqVy3E.js";const rt={stages:{s2:100,s3:300,s4:700,s5:1200}};function As({percent:n,label:p,color:i,striped:C}){const m=Math.max(0,Math.min(100,n)),v=i||"var(--color-primary,#16a34a)",A=C?{backgroundImage:"repeating-linear-gradient(45deg, rgba(255,255,255,.25) 0, rgba(255,255,255,.25) 10px, transparent 10px, transparent 20px)"}:void 0;return s.jsx("div",{"aria-label":p||"progress","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":Math.round(m),role:"progressbar",className:"h-2 bg-[var(--color-border,#e5e7eb)] rounded-lg",children:s.jsx("div",{className:"h-2 rounded-lg",style:{width:`${m}%`,background:v,...A||{}}})})}function Es(){const n=t.useRef(new Map),p="typesprout_keystats_v1";function i(){try{const h=localStorage.getItem(p);if(!h)return{};const c=JSON.parse(h);return c&&typeof c=="object"?c:{}}catch{return{}}}function C(h){try{localStorage.setItem(p,JSON.stringify(h))}catch{}}function m(h){const c=n.current.get(h)||{hits:0,misses:0,sumLatencyMs:0};c.lastDownAt=performance.now(),n.current.set(h,c)}function v(h,c){const S=n.current.get(h)||{hits:0,misses:0,sumLatencyMs:0};c?S.hits+=1:S.misses+=1,S.lastDownAt&&(S.sumLatencyMs+=performance.now()-S.lastDownAt),S.lastDownAt=void 0,n.current.set(h,S)}return t.useMemo(()=>({onKeyDown:m,onKeyUp:v,getErrRateByKey:h=>{const c=n.current.get(h),S=(c?.hits||0)+(c?.misses||0);return S>0?c.misses/S:0},getLatencyZ:h=>{let c=0,S=0;n.current.forEach(F=>{F.hits+F.misses>0&&(c+=F.sumLatencyMs/Math.max(1,F.hits+F.misses),S++)});const T=S>0?c/S:1,U=n.current.get(h);return((U&&U.hits+U.misses>0?U.sumLatencyMs/Math.max(1,U.hits+U.misses):T)-T)/(T||1)},persistSnapshot:()=>{const h=i();n.current.forEach((c,S)=>{const T=h[S]||{hits:0,misses:0};T.hits+=c.hits,T.misses+=c.misses,h[S]=T}),C(h)},getAggregatedErrMap:()=>{const h=i(),c={};return new Set([...Object.keys(h),...Array.from(n.current.keys())]).forEach(T=>{const U=h[T]||{hits:0,misses:0},w=n.current.get(T)||{hits:0,misses:0},F=U.hits+w.hits,q=U.misses+w.misses,B=F+q;c[T]=B>0?q/B:0}),c},dump:()=>n.current}),[])}const nt=50;async function ks(n){try{const p=Ae(D,"attempts"),i=ot(p,Re("uid","==",n),ct("ts","desc"),kt(nt+10)),m=(await it(i)).docs;if(m.length>nt){const v=m.slice(nt),A=Yt(D);v.forEach(h=>{A.delete(h.ref)}),await A.commit(),console.log(`Deleted ${v.length} old records, keeping user ${n} within ${nt} records limit`)}}catch(p){console.error("Error limiting user records:",p)}}async function Ds(n){await ks(n)}function Ls(n,p,i){return Math.max(p,Math.min(i,n))}function at(n=Date.now()){const p=new Date(n),i=p.getFullYear(),C=`${p.getMonth()+1}`.padStart(2,"0"),m=`${p.getDate()}`.padStart(2,"0");return`${i}-${C}-${m}`}async function Is(n){try{const p=at(),i=new Date(p+"T00:00:00");console.log("Gamification engine: Getting today earned",{uid:n,today:p,start:i.toISOString()});try{const C=ot(Ae(D,"economyLogs"),Re("uid","==",n),Re("ts",">=",Dt.fromDate(i)),ct("ts","desc"),kt(200)),m=await it(C);let v=0;return m.docs.forEach(A=>{const h=A.data();h.type==="earn"&&h.source==="attempt"&&(v+=Number(h.delta||0))}),console.log("Economy logs found:",{count:m.docs.length,sum:v}),v}catch(C){console.warn("Composite query failed, falling back to simple query:",C);const m=ot(Ae(D,"economyLogs"),Re("uid","==",n),ct("ts","desc"),kt(200)),v=await it(m);let A=0;const h=new Date(p+"T00:00:00");return v.docs.forEach(c=>{const S=c.data();(S.ts?.toDate?.()||new Date(S.ts))>=h&&S.type==="earn"&&S.source==="attempt"&&(A+=Number(S.delta||0))}),console.log("Simple query results:",{count:v.docs.length,sum:A}),A}}catch(p){return console.error("Error in getTodayAttemptEp:",p),0}}async function Us(n){const{uid:p,lang:i,durationSec:C,raw:m,adj:v,accuracy:A,correctChars:h,totalChars:c,totalQChars:S}=n;console.log("Applying attempt rewards:",{uid:p,lang:i,durationSec:C,raw:m,adj:v,accuracy:A,correctChars:h,totalChars:c,totalQChars:S});const T=Math.max(C,1)/60,U=["en-US","zh-TW","zh-CN"].includes(i)?i:"en-US",w=me.baseByLang[U],F=await Is(p),q=Math.max(0,me.dailyEpCap-F),B=z(D,"profiles",p),Ee=await we(B),ke=Ee.exists()?Ee.data():{},De=Number(ke.grade||3),se=me.targetByGrade[U]?.[De]||20,Qe=w*T*Ls(v/se,0,2)*(.5+.5*A);let R=Math.round(Qe);const he=A>=.3?Math.floor(C/10):0;R=Math.max(R,he),R<=0&&C>=30&&A>=.5&&(R=1);const K=Math.min(q,Math.max(0,R)),Be=z(D,"inventory",p),ve=await we(Be),H=ve.exists()?ve.data():{},Me=Date.now(),Ne=H.fertilizerActiveUntil?.toMillis?H.fertilizerActiveUntil.toMillis():Number(H.fertilizerActiveUntil||0),Oe=H.waterActiveUntil?.toMillis?H.waterActiveUntil.toMillis():Number(H.waterActiveUntil||0),ge=Ne>Me?1:0,Le=Oe>Me?1:0,re=Math.floor(K*(1+.2*ge+.1*Le)),ne=Yt(D),Ie=Number(ke.points||0)+K,Ge=Number(ke.xp||0)+K;ne.set(B,{points:Ie,xp:Ge,updatedAt:pe()},{merge:!0});const ae=z(D,"trees",p),Ce=await we(ae),V=Ce.exists()?Ce.data():{},G=Number(V.gpTotal||0)+re,oe=at(),ce=V.dailyDate||oe,lt=Number(V.dailyGp||0),Q=ce===oe?lt+re:re;let P=V.stage||1;G>=rt.stages.s5?P=5:G>=rt.stages.s4?P=4:G>=rt.stages.s3?P=3:G>=rt.stages.s2?P=2:P=1,Ce.exists()?ne.update(ae,{stage:P,gpTotal:G,dailyGp:Q,dailyDate:oe,lastActiveDate:at(),updatedAt:pe()}):ne.set(ae,{uid:p,seed:Math.floor(Math.random()*1e9),dna:{angle:22,branchVar:.3,leafHue:120,fruitHue:12},stage:P,gpTotal:G,dailyGp:Q,dailyDate:oe,lastActiveDate:at(),createdAt:pe(),updatedAt:pe()});const $e=Ae(D,"economyLogs"),We={uid:p,ts:pe(),type:"earn",source:"attempt",delta:K,balanceAfter:Ie,durationSec:C,raw:m,adj:v,accuracy:A,correctChars:h,totalChars:c,totalQChars:S};console.log("Economy log data:",We),ne.set(z($e),We),console.log("Committing batch transaction");try{await ne.commit(),console.log("Batch transaction committed successfully")}catch(Ue){throw console.error("Error committing batch transaction:",Ue),Ue}}function Xt(n){let p=0;for(let i=0;i<n.length;i++)p=(p<<5)-p+n.charCodeAt(i),p|=0;return String(p)}function Os(){const{t:n}=ys(),{currentBank:p}=js(),[i,C]=t.useState("Kids Typing & Tree Growth"),[m,v]=t.useState(""),[A,h]=t.useState(""),[c,S]=t.useState(!1),[T,U]=t.useState(5),[w,F]=t.useState([]),[q,B]=t.useState(0),[Ee,ke]=t.useState(!0),[De]=t.useState("auto"),[se,Qe]=t.useState(5);t.useEffect(()=>{[1,3,5].includes(se)||Qe(5)},[se]);const R=t.useCallback(e=>Math.max(1e3,Math.floor(e.length*se*1e3)),[se]),[he,K]=t.useState(0),[Be,ve]=t.useState([]),[H,Me]=t.useState([]),[Ne,Oe]=t.useState(null),[ge,Le]=t.useState(0),[re,ne]=t.useState(0),[Ie,Ge]=t.useState(0),[ae,Ce]=t.useState(!1),[V,G]=t.useState(""),oe=t.useRef(null),ce=t.useRef(!1),[lt,Q]=t.useState(n("test.promptStart")),[P,$e]=t.useState(!1),[We,Ue]=t.useState(!1),ut=xs(),{lang:M}=Ss(),{user:b}=bs(),[es,Lt]=t.useState(!1),[ze,It]=t.useState(!1),[ts,dt]=t.useState(!1),ie=Es(),ss=t.useRef(""),Je=t.useRef([]),le=t.useRef(0),ft=t.useRef(!1),mt=t.useRef(""),pt=t.useRef(0),Ut=t.useRef(1),He=t.useRef(!1),ht=t.useRef("typesprout_seen_ids"),gt=t.useRef([]),[yt,xt]=t.useState(null),[rs]=t.useState("exact"),[qt,St]=t.useState(0),[ns,bt]=t.useState(0),[_t,Ve]=t.useState([]),wt=t.useRef(0),Ft=t.useRef(0),Z=t.useRef(0),ye=t.useRef(!1),je=t.useRef(!1),as=t.useRef(0),Pt=t.useRef(!1),Kt=t.useRef(0),[Qt,Bt]=t.useState(!1),Ze=t.useRef(0),ue=t.useRef(0),os=t.useRef(0),xe=t.useRef(0),Xe=t.useRef(0),Ye=t.useRef(""),qe=t.useRef([]);t.useEffect(()=>{try{Zt(()=>import("./Result-B47avcVM.js"),__vite__mapDeps([0,1,2,3,4]))}catch{}},[]),t.useEffect(()=>{try{new URLSearchParams(window.location.search).get("e2e")==="1"&&U(1)}catch{}},[]),t.useEffect(()=>{(async()=>{try{if(!b){xt(null),Bt(!0);return}const e=z(D,"profiles",b.uid),r=await we(e),d=(r.exists()?r.data():void 0)?.grade,l=typeof d=="number"?d:Number(d??NaN);xt(Number.isFinite(l)?Math.max(1,Math.min(6,l)):null)}catch{xt(null)}finally{Bt(!0)}})()},[b]);async function Ot(e){try{const r=new Date().toLocaleDateString("en-CA"),g=new Date(r+"T00:00:00"),d=ot(Ae(D,"economyLogs"),Re("uid","==",e),Re("ts",">=",Dt.fromDate(g)),ct("ts","desc")),l=await it(d);let a=0;return l.docs.forEach(x=>{const E=x.data();E.type==="earn"&&E.source==="attempt"&&(a+=Number(E.delta||0))}),Ts("Test","getTodayEarned: 結果",{uid:e,sum:a,records:l.docs.length}),a}catch{return 0}}t.useEffect(()=>{Qt&&(async()=>{const e=++Ze.current;Ce(!0),G("");try{let r=function(o){let N=0;for(let y=0;y<o.length;y++)N=(N<<5)-N+o.charCodeAt(y),N|=0;return String(N)};const g=`typesprout_qs_cache_${M||"en-US"}`;try{const o=JSON.parse(localStorage.getItem(g)||"[]");if(Array.isArray(o)&&o.length>0&&e===Ze.current){F(o),B(0);const N=o[0]||"Kids Typing & Tree Growth";C(N),v(""),h(""),Q(n("test.promptStart"));const y=R(N);K(y),St(0),bt(0),Ve([]),wt.current=Date.now(),Z.current=0,ue.current=0,Xe.current=0,qe.current=[],Kt.current=o.length,je.current=!1;const I=new Uint8Array(16);crypto.getRandomValues(I),Ye.current=Array.from(I).map(Y=>Y.toString(16).padStart(2,"0")).join(""),le.current=0,xe.current=0}}catch{}const d=new AbortController,l=setTimeout(()=>d.abort(),1500);let a=null;try{const o=`typesprout_cursor_${M||"en-US"}`,N=Number(localStorage.getItem(o)||"0");let y=500,I=15;try{const te=await(await fetch("/index.json",{signal:d.signal})).json();te&&Number(te.pageSize)&&(y=Math.max(1,Number(te.pageSize))),te&&te.filesPerLang&&te.filesPerLang[M||"en-US"]&&(I=Number(te.filesPerLang[M||"en-US"]))}catch{}const Y=Math.max(1,Math.floor(N/y)+1),ee=Math.min(3,I),Jt=Math.max(1,Y-1);console.log("[Test] Loading content with questionBankType:",p),a=await Et({lang:M||"en-US",questionBankType:p,limit:y*ee,startPage:Jt,pageCount:ee,signal:d.signal}),console.log("[Test] Loaded items count:",a?.length||0),I>ee&&setTimeout(()=>{const Tt=I-ee,te=Jt+ee;Et({lang:M||"en-US",questionBankType:p,limit:y*Tt,startPage:te,pageCount:Tt,signal:void 0}).then(Rt=>{if(Rt&&Rt.length>0)try{const Ht=`typesprout_qs_cache_${M||"en-US"}`,ms=JSON.parse(localStorage.getItem(Ht)||"[]"),ps=Rt.map(Vt=>{const gs=Vt.structured;return String(gs?.q||Vt.text||"")}),hs=[...ms,...ps];localStorage.setItem(Ht,JSON.stringify(hs.slice(0,800)))}catch{}}).catch(()=>{})},100)}catch{a=null}finally{clearTimeout(l)}if(a||(a=[]),!a||!Array.isArray(a)||a.length===0){const o=(()=>{try{return localStorage.getItem("typesprout_last_content_source")||""}catch{return""}})();if(o==="local:lang-missing")G("Language not supported: en-US. Please try: en-US");else{const N=o.startsWith("remote")?"Remote content failed":"Local content failed";G(`Content loading failed: ${N}`)}F([]),B(0),C("Kids Typing & Tree Growth");return}let x=a;if(yt!=null){const o=yt,N=Math.max(1,o-1),y=Math.min(6,o+1);x=a.filter(I=>{const Y=Number(I.grade_min??NaN),ee=Number(I.grade_max??NaN);return!Number.isFinite(Y)||!Number.isFinite(ee)?!0:!(ee<N||Y>y)})}const E="typesprout_seen_ids",L=new Set(JSON.parse(localStorage.getItem(E)||"[]"));let _=new Set;try{if(b){const o=z(D,"profiles",b.uid),N=await we(o),y=N.data(),I=N.exists()&&Array.isArray(y?.lastSeenIds)?y?.lastSeenIds:[];_=new Set(I)}}catch{}const fe=new Set([...Array.from(L),...Array.from(_)]);x=x.filter(o=>typeof o.id=="string"&&!fe.has(String(o.id)));const Fe=x.map(o=>{const y=o.structured?.q||(typeof o.text=="string"?o.text:"Kids Typing & Tree Growth");return{id:typeof o.id=="string"&&o.id.length?o.id:r(y),text:y}}),k=new Set,f=[];for(const o of Fe)k.has(o.id)||(k.add(o.id),f.push(o));let u=f;if(u.length===0&&a&&a.length){const o=a.map(y=>{const Y=y.structured?.q||(typeof y.text=="string"?y.text:"Kids Typing & Tree Growth");return{id:typeof y.id=="string"&&y.id.length?y.id:r(Y),text:Y}}),N=new Set;u=[];for(const y of o)N.has(y.id)||(N.add(y.id),u.push(y))}const j=`typesprout_cursor_${M||"en-US"}`;let O=Number(localStorage.getItem(j)||"0");const $=u.length;if(b)try{const o=z(D,"profiles",b.uid),y=(await we(o)).data();y?.lastCursorLang===(M||"en-US")&&typeof y?.lastCursor=="number"&&(O=y.lastCursor,console.log("Test: Ready to start"))}catch{}const Ke=fe.size/Math.max(1,$)>.8;let J=0;if(Ke){if(localStorage.setItem(j,"0"),localStorage.setItem(E,"[]"),b)try{await At(z(D,"profiles",b.uid),{lastCursor:0,lastSeenIds:[]},{merge:!0})}catch{}console.log("Test: Content loaded successfully")}else J=Number.isFinite(O)?Math.max(0,Math.min(O,Math.max(0,$-1))):0;const W=[];for(let o=0;o<Math.min(T,$);o++)W.push(u[(J+o)%$]);const jt=(J+Math.min(T,$))%Math.max(1,$),ds=W.map(o=>o.id),fs=Array.from(new Set([...Array.from(fe),...ds]));mt.current=j,pt.current=jt,ht.current=E,gt.current=fs;const tt=W.map(o=>o.text);try{localStorage.setItem(g,JSON.stringify(tt))}catch{}if(e===Ze.current){F(tt),B(0);const o=tt[0]||"Kids Typing & Tree Growth";C(o),v(""),h(""),Q(n("test.promptStart"));const N=R(o);K(N),St(0),bt(0),Ve([]),wt.current=Date.now(),Z.current=0,ue.current=0,Xe.current=0,qe.current=[],Kt.current=tt.length,je.current=!1;const y=new Uint8Array(16);crypto.getRandomValues(y),Ye.current=Array.from(y).map(I=>I.toString(16).padStart(2,"0")).join(""),le.current=0,xe.current=0}}catch{G("Failed to load content"),F([]),B(0),C("Kids Typing & Tree Growth")}finally{e===Ze.current&&Ce(!1)}})()},[M,T,yt,rs,b,Qt,R]),t.useEffect(()=>{!c&&i&&K(R(i))},[se,i,c,R]),t.useEffect(()=>{c&&!de.current&&i&&ze&&(xe.current=performance.now(),_e.current=performance.now(),K(R(i)),de.current=!0,console.log("Test: Questions loaded"))},[c,i,ze,R,q]),t.useEffect(()=>{if(!c){dt(!1);return}if(ze){dt(!1);return}const e=setTimeout(()=>dt(!0),1e3);return()=>clearTimeout(e)},[c,ze]),t.useEffect(()=>{c&&(P||je.current||he<=0&&!ye.current&&(de.current=!1,setTimeout(()=>{ye.current||Ct.current()},0)))},[he,c,P]);const vt=t.useMemo(()=>{let e=0;for(let r=0;r<m.length&&r<i.length;r++)m[r]===i[r]&&e++;return e},[m,i]);qt+m.length;const X=ns+vt;console.log("Test: Component mounted");const Gt=t.useMemo(()=>Math.max(ge/1e3,.01)/60,[ge]),Se=t.useMemo(()=>De==="zh"||De==="auto"&&(M||"en-US").startsWith("zh"),[De,M]),Mt=t.useMemo(()=>(w||[]).reduce((e,r)=>e+(r?.length||0),0),[w]),be=t.useMemo(()=>Mt>0?X/Mt:0,[Mt,X]),$t=Se?X/Gt:X/5/Gt,Wt=t.useMemo(()=>$t,[$t]),cs=t.useMemo(()=>Math.max(0,Math.ceil(he/10)/100).toFixed(2),[he]);t.useMemo(()=>(w||[]).slice(0,Math.min(q+1,(w||[]).length)).reduce((e,r)=>e+(r?.length||0),0),[w,q]);const Nt=t.useMemo(()=>ae||V||!i||i.length===0||(w?.length||0)<=0?!1:R(i)>0,[ae,V,i,w,R]),de=t.useRef(!1),_e=t.useRef(null);t.useEffect(()=>{c&&oe.current?.focus()},[c]);function is(e){if(e.key==="Enter"){if(e.preventDefault(),Date.now()-Ft.current<300){Q("Please wait a moment");return}if(ce.current){Q("Please finish typing");return}if(m.length===0){Q("Please type something");return}w.length-1,Te()}}const Te=t.useCallback(()=>{if(je.current||ye.current)return;ye.current=!0;const e=m.length===0?"x":m,r=le.current;for(let f=r;f<e.length;f++){const u=e[f]||"",j=i[f]||"",O=u.length===1?u.toUpperCase():u;ie.onKeyUp(O,u===j)}le.current=e.length;const g=Math.max(0,i.length-m.length);console.log("Test: Input changed"),ue.current+=m.length,console.log("Test: Typing progress updated"),os.current+=g,St(f=>f+m.length+g),bt(f=>f+vt);const d=Math.max(0,Math.round(xe.current>0?performance.now()-xe.current:0)),l=m.length,x=Se?1.2:1,E=Math.round(Math.max(200,l*60*x)),L=d<E,_=Xt(i),fe=Xt(Ye.current+"|"+_+"|"+String(l)+"|"+String(d));qe.current.push({qid:_,chars:l,spentMs:d,mistakes:Z.current,fastViolation:L,tokenSig:fe}),!L&&l>0?(Xe.current+=d,ne(f=>f+d),Ge(f=>f+l),console.log("Test: Question processing")):console.log("t('ui.loading')"),g>0&&(Z.current+=g);const Fe={text:i,allowed:Math.floor(R(i)/1e3),spent:Math.floor((l>0?d:0)/1e3),mistakes:Z.current};Ve(f=>[...f,Fe]);try{ie.persistSnapshot()}catch{}Q("Time is up!");const k=()=>{if(ge>0&&(console.log("Test: Question completed"),ne(f=>{const u=f+ge;return console.log("Test: Total time updated"),u}),Ge(f=>{const u=f+m.length;return console.log("Test: Total chars updated"),u})),q<w.length-1){const f=q+1;as.current+=1,B(f);const u=w[f]||"Kids Typing & Tree Growth";C(u),v(""),h(""),K(R(u)),Q(""),de.current=!1,Z.current=0,le.current=0;const j=performance.now();Oe(j),Le(0),_e.current=j,de.current=!0,xe.current=j}else{je.current=!0,S(!1),$e(!0),Q(n("test.promptFinished"));try{console.log("Test: 自動保存測驗結果"),setTimeout(()=>{zt.current().then(()=>{console.log("Test component mounted")}).catch(W=>{console.error("Error persisting attempt:",W)})},0);const f=ue.current>0||qe.current.some(W=>W.chars>0),u=f?Math.max(1,re):0,j=u/6e4,O=f?ue.current:0,$=f&&j>0?Se?O/j:O/5/j:0,Pe=f?be:0,Ke=$*Pe,J=w.reduce((W,jt)=>W+(jt?.length||0),0);Pt.current||(Pt.current=!0,setTimeout(()=>{ut(`/${M}/result`,{state:{rawWpm:$,accuracy:Pe,adjWpm:Ke,durationSec:Number((u/1e3).toFixed(2)),rawChars:O,totalQChars:J,fromTest:!0}})},100))}catch{}}};setTimeout(()=>{k(),ye.current=!1},200)},[be,Se,ie,M,ut,q,w,i,R,m,vt,n,ge,re]),Ct=t.useRef(Te);t.useEffect(()=>{Ct.current=Te},[Te]),t.useEffect(()=>{if(!c||P||je.current||!de.current||!Ne)return;let e=0;const r=g=>{const d=_e.current??g,l=g-d;_e.current=g,Ne&&Le(x=>x+l);let a=!1;if(K(x=>{const E=x-l;return E<=0?(a=!0,0):E}),a&&!ye.current){de.current=!1,requestAnimationFrame(()=>{ye.current||Ct.current()});return}e=requestAnimationFrame(r)};return e=requestAnimationFrame(r),()=>cancelAnimationFrame(e)},[c,P,Ne]),t.useEffect(()=>{(async()=>{try{if(!b){ve([]),Me([]);return}const r=(await Rs({uid:b.uid,days:30,sampleLimit:200})).slice().reverse(),g=a=>{if(!a)return;if(a instanceof Date)return a;if(typeof a=="number")return new Date(a);const x=a;return typeof x.toDate=="function"?x.toDate():void 0},d=r.map((a,x)=>({i:x,adj:Number(a.adjWpm||0),ts:g(a.ts),durationSec:Number(a.durationSec||0),rawChars:Number(a.rawChars||0),accuracy:Math.max(0,Math.min(1,Number(a.accuracy||0))),totalQChars:Number(a.totalQChars||0)})),l=r.map((a,x)=>({i:x,acc:Math.max(0,Math.min(1,Number(a.accuracy||0))),ts:g(a.ts),durationSec:Number(a.durationSec||0),rawChars:Number(a.rawChars||0),accuracy:Math.max(0,Math.min(1,Number(a.accuracy||0))),totalQChars:Number(a.totalQChars||0)}));ve(d),Me(l)}catch{ve([]),Me([])}})()},[b]),t.useEffect(()=>{if(!w||w.length===0)return;if(Math.max(0,w.length-1-q)<=10&&!He.current){He.current=!0;try{const g=M||"en-US",d=Math.max(1,Ut.current);Et({lang:g,questionBankType:p,limit:200,startPage:d,pageCount:1,signal:void 0}).then(l=>{if(!(!l||!l.length)){try{const a=`typesprout_qs_cache_${g}`,E=[...JSON.parse(localStorage.getItem(a)||"[]"),...l.map(L=>String(L.structured?.q||L.text||""))];localStorage.setItem(a,JSON.stringify(E.slice(0,1e3)))}catch(a){console.warn("Failed to load page size from index.json:",a)}Ut.current=d+1}}).finally(()=>{He.current=!1})}catch{He.current=!1}}},[q,w,M]);const et=t.useCallback(async()=>{try{if(!b)return;const e=Se,r=Ie,g=Math.max(1,re),d=g/6e4,l=e?r/d:r/5/d,a=be,x=l*a;if(r/Math.max(1,g/1e3)*60>me.humanMaxCpm||!e&&l>200||e&&l>400)return;const L={uid:b.uid,ts:Dt.now(),lang:M||"en-US",mode:"test-perchar",durationSec:Number((g/1e3).toFixed(2)),rawChars:r,correctChars:X,accuracy:Number(a.toFixed(4)),adjWpm:Number(x.toFixed(2)),nick:b.displayName||"",createdAt:pe(),sessionToken:Ye.current,totalInputMs:Math.round(g),totalChars:r,questions:qe.current};try{const k=z(D,"profiles",b.uid),u=(await we(k)).data(),j=typeof u?.classCode=="string"?u.classCode:void 0;j&&(L.classCode=String(j))}catch{}try{const k=ie.dump(),f={};k.forEach((u,j)=>{(u.hits||0)+(u.misses||0)>0&&(f[j]={h:u.hits||0,m:u.misses||0})}),L.keystats=f}catch{}e?L.cpm=Number(l.toFixed(2)):L.rawWpm=Number(l.toFixed(2));const _=await Ot(b.uid);try{await Ds(b.uid)}catch(k){console.warn("Error getting today earned:",k)}await ws(Ae(D,"attempts"),L);const fe=w.reduce((k,f)=>k+(f?.length||0),0);console.log("Test attempt data:",{uid:b.uid,lang:M||"en-US",durationSec:Number((g/1e3).toFixed(2)),raw:l,adj:x,accuracy:a,correctChars:X,totalChars:r,totalQChars:fe});try{await Us({uid:b.uid,lang:M||"en-US",durationSec:Number((g/1e3).toFixed(2)),raw:l,adj:x,accuracy:a,correctChars:X,totalChars:r,totalQChars:fe}),console.log("Attempt rewards applied successfully")}catch(k){console.error("Error applying attempt rewards:",k)}try{let k=await Ot(b.uid);k<_&&(k=_);let f=Math.max(0,Math.round(k-_));if(f<=0){const j=M||"en-US",O=me.baseByLang[j],$=Math.max(g/1e3,1)/60,Pe=me.targetByGrade[j]?.[3]||20,Ke=O*$*Math.max(0,Math.min(2,x/Pe))*(.5+.5*a);let J=Math.round(Ke);J<=0&&(g/1e3>=30&&a>=.5||g/1e3>=5&&a>=.3)&&(J=1);const W=Math.max(0,me.dailyEpCap-_);f=Math.max(0,Math.min(W,J)),k=Math.min(me.dailyEpCap,_+f)}const u=document.createElement("div");u.role="status",u.setAttribute("aria-live","polite"),u.textContent="Loading questions...",u.style.position="fixed",u.style.right="16px",u.style.bottom="16px",u.style.background="#111827",u.style.color="#fff",u.style.padding="8px 12px",u.style.borderRadius="8px",u.style.boxShadow="0 2px 8px rgba(0,0,0,.2)",document.body.appendChild(u),setTimeout(()=>{try{document.body.removeChild(u)}catch{}},1600)}catch{}const Fe=z(D,"profiles",b.uid);await At(Fe,{attemptsCount:vs(1),lastAttempt:{ts:pe(),lang:M||"en-US",durationSec:Number((g/1e3).toFixed(2)),rawChars:r,correctChars:X,accuracy:Number(a.toFixed(4)),adjWpm:Number(x.toFixed(2)),metric:e?"cpm":"wpm",raw:Number(l.toFixed(2))},updatedAt:pe()},{merge:!0})}catch(e){const r=typeof e=="object"&&e&&"message"in e?String(e.message):"";/Missing or insufficient permissions/i.test(r)&&alert("Permission denied. Please check your login status.")}},[b,M,Se,be,ie,X,re,Ie]),zt=t.useRef(et);t.useEffect(()=>{zt.current=et},[et]);const ls=he/1e3<=10&&c;function us(){const e=[];for(let r=0;r<i.length;r++){const g=i[r];let d="";r<m.length?d=m[r]===g?"text-[var(--color-success)]":"text-[var(--color-danger)] underline decoration-[var(--color-danger)]":r===m.length&&c?d="bg-sky-100 border-b-2 border-sky-400":d="text-[var(--color-muted,#6b7280)]",e.push(s.jsx("span",{className:d,children:g},r))}return s.jsx("p",{className:"font-mono typing-text break-words",children:e})}return s.jsxs("div",{className:"max-w-[960px] mx-auto px-4",children:[s.jsx("h2",{className:"h2 mb-3",children:n("test.title")}),s.jsxs("div",{className:"flex flex-wrap items-center gap-3","aria-keyshortcuts":"Space R F Enter",children:[s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("span",{children:n("test.questionCount")}),s.jsxs("select",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",value:T,onChange:e=>U(parseInt(e.target.value)),children:[s.jsx("option",{value:5,children:"5"}),s.jsx("option",{value:10,children:"10"}),s.jsx("option",{value:20,children:"20"}),s.jsx("option",{value:30,children:"30"}),s.jsx("option",{value:60,children:"60"})]})]}),s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("span",{children:n("test.difficulty")}),s.jsxs("select",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",value:se,onChange:e=>Qe(parseInt(e.target.value)),children:[s.jsx("option",{value:1,children:n("test.difficultyHard")}),s.jsx("option",{value:3,children:n("test.difficultyMedium")}),s.jsx("option",{value:5,children:n("test.difficultyEasy")})]})]}),s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",checked:Ee,onChange:e=>ke(e.target.checked)})," ",n("test.allowBackspace")]}),es&&s.jsx("div",{className:"ml-auto px-2 py-1 rounded bg-[var(--color-warning)] text-white",children:n("test.capsLock")})]}),ae&&s.jsx("div",{className:"mt-2 px-3 py-2 rounded bg-sky-50 text-sky-700 border border-sky-200",role:"status","aria-live":"polite",children:n("test.loadingQuestions")}),!!V&&s.jsx("div",{className:"mt-2 px-3 py-2 rounded bg-red-50 text-red-600 border border-red-200",role:"alert","aria-live":"assertive",children:V}),s.jsxs("div",{className:"mt-3 relative",children:[s.jsxs("div",{className:`absolute right-0 -top-2 font-bold tabular-nums ${ls?"text-[var(--color-danger,#ef4444)]":"text-[var(--color-surface-foreground,#111827)]"} text-2xl`,"aria-live":"polite",role:"status",children:[cs,"s"]}),s.jsx("div",{className:"text-[var(--color-muted)] text-sm leading-[var(--lh-normal)] text-left",children:ae?n("test.loadingQuestions"):n("test.progress",{current:q+1,total:T})}),s.jsx(As,{label:"progress",percent:m.length/i.length*100}),s.jsxs("div",{className:"mt-2",onCopy:e=>e.preventDefault(),onCut:e=>e.preventDefault(),onContextMenu:e=>e.preventDefault(),children:[s.jsx("div",{className:"text-[var(--color-muted)] text-sm leading-[var(--lh-normal)] mb-1",children:n("test.inputPrompt")}),s.jsx("div",{className:"select-none",draggable:!1,"aria-label":n("test.questionText"),children:us()})]}),s.jsxs("div",{className:"mt-1",children:[s.jsxs("div",{className:"relative",children:[s.jsx("textarea",{ref:oe,rows:4,value:A,readOnly:!c,"aria-disabled":!c,onBeforeInput:e=>{const r=e;c||r.preventDefault(),r.inputType==="insertFromPaste"&&r.preventDefault()},onDrop:e=>{e.preventDefault()},onFocus:()=>{if(It(!0),c&&!Ne){const e=performance.now();Oe(e),Le(0),_e.current=e,K(R(i)),de.current=!0,xe.current=e}},onBlur:()=>It(!1),onKeyDown:e=>{if(!c){e.preventDefault(),Q(n("test.promptBegin"));return}if(e.key==="Enter"){is(e);return}Lt(e.getModifierState("CapsLock"));const r=e.key.length===1?e.key.toUpperCase():e.key;ss.current=r,ie.onKeyDown(r),ce.current&&Je.current.push(r),!Ee&&(e.key==="Backspace"||e.key==="Delete")&&e.preventDefault()},onKeyUp:e=>{if(!c){e.preventDefault();return}if(Lt(e.getModifierState("CapsLock")),ce.current)return;const r=le.current;if(m.length>r){ft.current=!0;const d=r,l=m[d]||"",a=i[d]||"",x=l.length===1?l.toUpperCase():l;ie.onKeyUp(x,l===a),l!==a&&(Z.current+=1)}le.current=m.length},onCompositionStart:()=>{ce.current=!0,Je.current=[]},onCompositionEnd:e=>{ce.current=!1;const r=e.target.value,d=m.length,l=r[d]||"",a=i[d]||"",x=l===a;for(const E of Je.current)ie.onKeyUp(E,x);Je.current=[],x||(Z.current+=1),le.current=r.length,h(r),c&&v(r),r.length>0&&(ft.current=!0)},onChange:e=>{const r=e.target.value;h(r),!(ce.current||!c)&&v(r)},className:"w-full p-3 border border-[var(--color-border,#e5e7eb)] rounded-[12px] font-mono min-h-[120px] focus:outline-none focus:ring-2 focus:ring-sky-400 typing-input"}),!c&&!P&&s.jsx("div",{className:"absolute inset-0 bg-white/60 flex items-center justify-center rounded-[12px]",children:s.jsx(st,{disabled:!Nt,onClick:()=>{if(Nt){Ft.current=Date.now(),S(!0);try{mt.current&&localStorage.setItem(mt.current,String(pt.current))}catch{}try{ht.current&&localStorage.setItem(ht.current,JSON.stringify(gt.current))}catch{}try{b&&At(z(D,"profiles",b.uid),{lastSeenIds:gt.current.slice(-1e3),lastCursor:pt.current,lastCursorLang:M||"en-US"},{merge:!0})}catch{}setTimeout(()=>{oe.current?.focus()},0),wt.current=Date.now(),Z.current=0,ft.current=!1}},children:n("ui.start")})})]}),c&&s.jsx("div",{className:"mt-2 flex items-center gap-3",children:s.jsx(st,{onClick:()=>Te(),children:n("test.submitQuestion")})})]})]}),s.jsx("div",{"aria-live":"polite",className:"mt-2 body muted",children:lt}),ts&&c&&s.jsx("div",{role:"status","aria-live":"polite",className:"mt-2 px-3 py-2 rounded bg-yellow-50 text-[var(--color-warning)] border border-yellow-200",children:n("test.outOfFocus")}),s.jsx("div",{className:"sticky bottom-0 bg-white py-3 mt-3 border-t border-[var(--color-border,#e5e7eb)]",children:s.jsx("div",{className:"flex items-center justify-end gap-3 flex-wrap",children:s.jsx("div",{className:"text-[var(--color-muted,#6b7280)] text-sm",children:n("test.shortcutsDescription")})})}),P&&s.jsxs("div",{style:{marginTop:12},children:[s.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"},children:[s.jsx("strong",{children:n("test.finished")}),s.jsx("span",{children:n("test.accuracyLabel",{accuracy:(be*100).toFixed(0)})}),s.jsx("span",{children:n("test.adjWpmLabel",{adjWpm:Wt.toFixed(1)})}),s.jsx(st,{disabled:We||!b,onClick:async()=>{try{Ue(!0),await et();const e=ue.current>0,r=e?Math.max(1,Xe.current):0,g=r/6e4,d=e?ue.current:0,l=e?Se?d/g:d/5/g:0,a=e?be:0,x=l*a,E=w.reduce((L,_)=>L+(_?.length||0),0);ut(`/${M}/result`,{state:{rawWpm:l,accuracy:a,adjWpm:x,durationSec:Number((r/1e3).toFixed(2)),rawChars:d,totalQChars:E}});try{(await Zt(async()=>{const{markPracticedNow:L}=await import("./index-D4RQrBUQ.js").then(_=>_.aq);return{markPracticedNow:L}},__vite__mapDeps([1,2]))).markPracticedNow()}catch{}}finally{Ue(!1)}},children:n("test.submitAndReview")}),!b&&s.jsx("span",{className:"text-[var(--color-muted,#6b7280)]",children:n("test.signInToSave")}),s.jsx(st,{variant:"outline",onClick:()=>{v(""),h(""),$e(!1),Q(n("test.promptStart")),B(0);const e=w[0]||"Kids Typing & Tree Growth";C(e),K(R(e)),S(!1),Ve([]),ue.current=0},children:n("test.tryAgain")})]}),_t.length>0&&s.jsxs("div",{className:"mt-4",children:[s.jsx("div",{className:"mb-2 text-sm text-[var(--color-muted,#6b7280)]",children:n("test.questionStats")}),s.jsxs("table",{className:"w-full text-sm border-collapse",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"text-left border-b border-[var(--color-border,#e5e7eb)]",children:[s.jsx("th",{className:"py-1 pr-2",children:"#"}),s.jsx("th",{className:"py-1 pr-2",children:n("test.questionPreview")}),s.jsx("th",{className:"py-1 pr-2",children:n("test.timeSpent")}),s.jsx("th",{className:"py-1 pr-2",children:n("test.timeLimit")}),s.jsx("th",{className:"py-1 pr-2",children:n("test.mistakes")})]})}),s.jsx("tbody",{children:_t.map((e,r)=>s.jsxs("tr",{className:"border-b border-[var(--color-border,#e5e7eb)]",children:[s.jsx("td",{className:"py-1 pr-2",children:r+1}),s.jsxs("td",{className:"py-1 pr-2",children:[e.text.slice(0,24),e.text.length>24?"…":""]}),s.jsxs("td",{className:"py-1 pr-2",children:[e.spent,"s"]}),s.jsxs("td",{className:"py-1 pr-2",children:[e.allowed,"s"]}),s.jsx("td",{className:"py-1 pr-2",children:e.mistakes})]},r))})]})]})]}),s.jsx("div",{className:"mt-6",children:s.jsxs("details",{children:[s.jsx("summary",{className:"cursor-pointer select-none",children:n("test.insightsSummary")}),s.jsx("div",{className:"mt-3 flex flex-wrap gap-6 items-start",children:s.jsxs(Ms,{topText:n("test.chartDescription"),children:[s.jsx(Ns,{data:Be.length?Be:Array.from({length:Math.min(30,Math.max(1,Math.floor((qt+m.length)/10)))},(e,r)=>({i:r,adj:Math.max(0,Number((Wt*(r+1)/30).toFixed(2)))}))}),s.jsx("div",{className:"h-3"}),s.jsx(Cs,{data:H.length?H:Array.from({length:30},(e,r)=>({i:r,acc:Math.max(0,Math.min(1,be))}))})]})})]})})]})}export{Os as default};
