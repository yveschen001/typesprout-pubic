import{b as H,u as z,c as $,r as v,x as B,h as w,w as k,o as Z,n as J,q as Q,f as V,e as U,i as X,g as G,d as q,j as t,T as _}from"./index-D4RQrBUQ.js";function ee(j,g){const s=g.lang,m=s.startsWith("zh");console.log("filterAttempts: starting with",j.length,"attempts"),console.log("filterAttempts: opts",g);let r=j;return console.log("filterAttempts: after start",r.length),r=r.filter(l=>l.lang===s),console.log("filterAttempts: after lang filter",r.length,"lang:",s),r=r.filter(l=>{const n=l.durationSec>=5&&l.accuracy>=0&&l.accuracy<=1;return n||console.log("filterAttempts: filtered out by duration/accuracy:",{durationSec:l.durationSec,accuracy:l.accuracy,uid:l.uid}),n}),console.log("filterAttempts: after duration/accuracy filter",r.length),r=r.filter(l=>{const n=m?l.cpm:l.rawWpm;if(!n)return console.log("filterAttempts: filtered out by missing raw speed:",{cpm:l.cpm,rawWpm:l.rawWpm,isZh:m,uid:l.uid}),!1;const f=m?n<=400:n<=200;return f||console.log("filterAttempts: filtered out by speed limit:",{raw:n,isZh:m,limit:m?400:200,uid:l.uid}),f}),console.log("filterAttempts: after speed filter",r.length),r=r.filter(l=>g.classCode?l.classCode===g.classCode:!0),console.log("filterAttempts: after classCode filter",r.length),r=r.filter(l=>{if(!g.gradeFilter)return!0;const n=g.uidToGrade?.[l.uid],f=typeof n=="number"?n===g.gradeFilter:!1;return f||console.log("filterAttempts: filtered out by grade:",{uid:l.uid,grade:n,gradeFilter:g.gradeFilter,uidToGrade:g.uidToGrade}),f}),console.log("filterAttempts: after grade filter",r.length),r}function te(j,g=20,s="today"){const m=new Map,r=new Date;let l,n;if(s==="today"){const e=new Date(r.getFullYear(),r.getMonth(),r.getDate());l=e.toLocaleDateString("en-CA"),n=e.toLocaleDateString("en-CA")}else if(s==="yesterday"){const e=new Date(r.getTime()-864e5),u=new Date(e.getFullYear(),e.getMonth(),e.getDate());l=u.toLocaleDateString("en-CA"),n=u.toLocaleDateString("en-CA")}else if(s==="lastWeek"){const e=r.getDay(),u=e===0?6:e-1,p=new Date(r.getTime()-u*24*60*60*1e3),x=new Date(p.getTime()-10080*60*1e3),y=new Date(x.getTime()+8640*60*1e3);l=x.toLocaleDateString("en-CA"),n=y.toLocaleDateString("en-CA")}else{const e=new Date(r.getFullYear(),r.getMonth()-1,1),u=new Date(r.getFullYear(),r.getMonth(),0);l=e.toLocaleDateString("en-CA"),n=u.toLocaleDateString("en-CA")}console.log("toTopN: processing period",s,"from",l,"to",n),console.log("toTopN: total attempts to process",j.length);let f=0;j.forEach(e=>{const p=(e.ts?.toDate?.()||new Date(e.ts)).toLocaleDateString("en-CA");if(p<l||p>n){console.log("toTopN: skipping attempt from",p,"not in range",l,"to",n);return}f++;const x=e.uid;m.has(x)||m.set(x,{uid:x,totalDuration:0,totalChars:0,avgAccuracy:0,maxAdjWpm:0,attempts:[]});const y=m.get(x);y.totalDuration+=e.durationSec||0,y.totalChars+=e.rawChars||0,y.avgAccuracy+=e.accuracy||0,y.maxAdjWpm=Math.max(y.maxAdjWpm,e.adjWpm||0),y.attempts.push(e)}),m.forEach(e=>{e.attempts.length>0&&(e.avgAccuracy=e.avgAccuracy/e.attempts.length)}),console.log("toTopN: processed attempts",f,"unique users",m.size);const S=Array.from(m.values()).map(e=>{const u=Math.min(e.totalDuration/60,2),p=e.maxAdjWpm*e.avgAccuracy*u;return{uid:e.uid,score:p,totalDuration:e.totalDuration,totalChars:e.totalChars,avgAccuracy:e.avgAccuracy,maxAdjWpm:e.maxAdjWpm,attempts:e.attempts}});return S.sort((e,u)=>u.score-e.score),console.log("toTopN: user merge results:",{totalUsers:S.length,topUsers:S.slice(0,5).map(e=>({uid:e.uid,score:e.score,totalDuration:e.totalDuration,maxAdjWpm:e.maxAdjWpm,avgAccuracy:e.avgAccuracy}))}),S.slice(0,g).map(e=>({...e.attempts.reduce((p,x)=>(x.adjWpm||0)>(p.adjWpm||0)?x:p),totalDuration:e.totalDuration,totalChars:e.totalChars,avgAccuracy:e.avgAccuracy,maxAdjWpm:e.maxAdjWpm,mergedScore:e.score}))}function re(){const{lang:j}=H(),g=j||"en-US",{t:s}=z(),{user:m}=$(),[r,l]=v.useState("today"),[n,f]=v.useState([]),[S,e]=v.useState(!0),[u,p]=v.useState(""),[x,y]=v.useState(!0),[C,O]=v.useState(void 0),[T,E]=v.useState(""),[W,P]=B();v.useEffect(()=>{const a=Number(W.get("grade")||"");O(Number.isFinite(a)&&a>0?a:void 0),E(W.get("class")||"")},[]),v.useEffect(()=>{Y()},[g,r,C,T]);async function Y(){e(!0),p("");try{const a=new Date;let c,h;if(r==="today"){const o=new Date(a.getFullYear(),a.getMonth(),a.getDate()),i=new Date(o.getTime()+1440*60*1e3);c=w.fromDate(o),h=w.fromDate(i)}else if(r==="yesterday"){const o=new Date(a.getTime()-864e5),i=new Date(o.getFullYear(),o.getMonth(),o.getDate()),d=new Date(i.getTime()+1440*60*1e3);c=w.fromDate(i),h=w.fromDate(d)}else if(r==="lastWeek"){const o=a.getDay(),i=o===0?6:o-1,d=new Date(a.getTime()-i*24*60*60*1e3),b=new Date(d.getTime()-10080*60*1e3),A=new Date(b.getTime()+10080*60*1e3);c=w.fromDate(new Date(Date.UTC(b.getFullYear(),b.getMonth(),b.getDate(),0,0,0))),h=w.fromDate(new Date(Date.UTC(A.getFullYear(),A.getMonth(),A.getDate()+1,0,0,0)))}else{const o=new Date(a.getFullYear(),a.getMonth()-1,1),i=new Date(a.getFullYear(),a.getMonth(),1);c=w.fromDate(new Date(Date.UTC(o.getFullYear(),o.getMonth(),o.getDate(),0,0,0))),h=w.fromDate(new Date(Date.UTC(i.getFullYear(),i.getMonth(),i.getDate(),0,0,0)))}const M=[k("lang","==",g),k("ts",">=",c)];h&&M.push(k("ts","<",h)),M.push(Z("ts","desc")),M.push(J(1e3));const K=Q(V(U,"attempts"),...M),D=(await X(K)).docs.map(o=>({id:o.id,...o.data()}));console.log("Leaderboard fetch:",{period:r,L:g,attemptsCount:D.length,firstFew:D.slice(0,3),since:c.toDate(),until:h?.toDate(),sinceISO:c.toDate().toISOString(),untilISO:h?.toDate().toISOString(),now:new Date().toISOString(),query:{lang:g,since:c.toDate(),until:h?.toDate(),limit:1e3}}),D.length>0&&(console.log("Found attempts in time range"),D.forEach((o,i)=>{const d=o.ts?.toDate?.()?.toISOString().slice(0,10)||new Date(o.ts).toISOString().slice(0,10),b=c.toDate().toISOString().slice(0,10),A=h?.toDate().toISOString().slice(0,10);console.log(`Attempt ${i} details:`,{attemptDate:d,sinceDate:b,untilDate:A,inRange:d>=b&&(!A||d<A)})})),D.length>0&&(console.log("Leaderboard detailed attempt data:"),D.slice(0,2).forEach((o,i)=>{console.log(`Attempt ${i+1}:`,{id:o.id,uid:o.uid,lang:o.lang,durationSec:o.durationSec,accuracy:o.accuracy,rawWpm:o.rawWpm,cpm:o.cpm,adjWpm:o.adjWpm,classCode:o.classCode,ts:o.ts?.toDate?.()||o.ts})}));let L;if(C){const o=Array.from(new Set(D.map(d=>d.uid))).slice(0,50),i=await Promise.all(o.map(async d=>{const b=await G(q(U,"profiles",d));return[d,Number(b.data()?.grade||0)]}));L=Object.fromEntries(i)}const I=ee(D,{lang:g,classCode:T||void 0,gradeFilter:C,uidToGrade:L});console.log("Leaderboard filtered:",{originalCount:D.length,filteredCount:I.length,grade:C,classCode:T,uidToGradeKeys:Object.keys(L||{})});const F=te(I,1e3,r);console.log("Leaderboard ranked:",{rankedCount:F.length,firstFew:F.slice(0,3)});const N=F.slice(0,20);console.log("Leaderboard final top:",{topCount:N.length,top:N.slice(0,3)});const R=N.filter(o=>!o.photoURL).map(o=>o.uid);if(R.length){const o=await Promise.all(R.map(async d=>{const b=await G(q(U,"profiles",d));return[d,b.data()?.photoURL||""]})),i=Object.fromEntries(o);for(const d of N)!d.photoURL&&i[d.uid]&&(d.photoURL=i[d.uid])}f(N)}catch(a){console.error("Failed to fetch leaderboard data:",a),p("Failed to load leaderboard data"),f([])}finally{e(!1)}}return t.jsxs("div",{className:"max-w-[960px] mx-auto px-4",children:[t.jsx("h2",{className:"h2 mb-3",children:s("nav.leaderboard")}),t.jsx(t.Fragment,{}),!m&&t.jsx("div",{className:"mb-3 text-[12px] text-[var(--color-muted,#6b7280)]",children:s("leaderboard.signInHint")}),S&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx("p",{className:"text-gray-600 mb-4",children:s("leaderboard.loading")}),t.jsx("p",{className:"text-sm text-gray-500",children:s("leaderboard.loadingHint")})]}),u&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx("p",{className:"text-red-600 mb-4",children:u}),t.jsx("button",{onClick:()=>Y(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:s("leaderboard.reload")})]}),t.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-3 rounded-[12px] border p-2 bg-gradient-to-b from-emerald-50/30 to-white",children:[t.jsxs("select",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",value:r,onChange:a=>l(a.target.value),children:[t.jsx("option",{value:"today",children:s("leaderboard.today")}),t.jsx("option",{value:"yesterday",children:s("leaderboard.yesterday")}),t.jsx("option",{value:"lastWeek",children:s("leaderboard.lastWeek")}),t.jsx("option",{value:"lastMonth",children:s("leaderboard.lastMonth")})]}),t.jsxs("select",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",value:String(C||""),onChange:a=>{const c=Number(a.target.value||"");O(Number.isFinite(c)&&c>0?c:void 0);const h=new URLSearchParams(W);c?h.set("grade",String(c)):h.delete("grade"),P(h)},children:[t.jsx("option",{value:"",children:s("leaderboard.allGrades")}),t.jsx("option",{value:"1",children:s("leaderboard.grade",{grade:1})}),t.jsx("option",{value:"2",children:s("leaderboard.grade",{grade:2})}),t.jsx("option",{value:"3",children:s("leaderboard.grade",{grade:3})}),t.jsx("option",{value:"4",children:s("leaderboard.grade",{grade:4})}),t.jsx("option",{value:"5",children:s("leaderboard.grade",{grade:5})}),t.jsx("option",{value:"6",children:s("leaderboard.grade",{grade:6})})]}),t.jsx("input",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",placeholder:s("leaderboard.classCodePlaceholder"),value:T,onChange:a=>{E(a.target.value);const c=new URLSearchParams(W);a.target.value?c.set("class",a.target.value):c.delete("class"),P(c)}}),t.jsx("div",{className:"flex items-center gap-2 text-sm text-[var(--color-muted,#6b7280)]",children:t.jsx(_,{label:s("leaderboard.tooltip")})})]}),t.jsx("div",{className:"body muted mb-2","aria-keyshortcuts":"Alt+ArrowUp, Alt+ArrowDown",children:s("leaderboard.sortHint")}),t.jsxs("ol",{className:"space-y-2",onKeyDown:a=>{a.altKey&&a.key==="ArrowUp"&&y(!1),a.altKey&&a.key==="ArrowDown"&&y(!0)},tabIndex:0,"aria-label":"Leaderboard list",children:[n.map((a,c)=>t.jsxs("li",{className:"flex items-center justify-between rounded-[12px] border px-3 py-2",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"grid place-items-center w-8 h-8 rounded-full bg-[var(--color-primary,#16a34a)]/10 text-[var(--color-primary,#16a34a)] font-semibold",children:c+1}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("img",{src:a.photoURL||"https://lh3.googleusercontent.com/a/default-user=s32",alt:"avatar",className:"w-8 h-8 rounded-full object-cover",referrerPolicy:"no-referrer"}),t.jsx("div",{className:"font-medium",children:a.nick||a.uid.slice(0,6)}),t.jsx("div",{className:"text-xs text-[var(--color-muted,#6b7280)]",children:a.totalDuration?s("leaderboard.noData"):s("home.leaderScore")})]})]}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"tabular-nums text-lg font-semibold",children:Number(a.maxAdjWpm||a.adjWpm).toFixed(1)}),a.totalChars&&t.jsx("div",{className:"text-xs text-[var(--color-muted,#6b7280)]",children:s("leaderboard.stats",{chars:a.totalChars,accuracy:Math.round(a.avgAccuracy*100)})})]})]},a.id)),n.length===0&&t.jsx("div",{className:"text-[var(--color-muted,#6b7280)]",children:s("leaderboard.noData")})]})]})}export{re as default};
