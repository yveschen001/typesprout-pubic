import{r as c,u as _,c as ee,b as te,t as w,d as ae,e as F,g as se,q as re,f as ne,w as G,h as oe,o as ie,i as ce,j as t,B as f,s as le,S as k,T as de}from"./index-Dtk1fXa2.js";import{l as me,h as ue,r as ge,u as $}from"./api-G5qA_UV0.js";function be(){const[u,D]=c.useState("tree"),{t:a}=_(),{user:n}=ee(),{lang:S}=te(),[he,z]=c.useState(0),[l,b]=c.useState(1),[m,M]=c.useState([]),[B,g]=c.useState(null),I=c.useMemo(()=>m.filter(e=>e.active).length,[m]);c.useEffect(()=>{(async()=>{try{if(!n){g(null);return}const e=S||"en-US",s=w.baseByLang[e],o=ae(F,"profiles",n.uid),r=await se(o),i=r.exists()?r.data():{},d=Math.max(1,Math.min(6,Number(i.grade||3))),v=w.targetByGrade[e]?.[d]||20,x=i.lastAttempt||{},J=Math.max(0,Math.min(1,Number(x.accuracy??.85))),K=Number(x.adjWpm??v*.8),O=Math.max(0,Math.min(2,K/v)),y=s*O*(.5+.5*J),V=new Date().toLocaleDateString("en-CA"),X=new Date(V+"T00:00:00"),Y=re(ne(F,"economyLogs"),G("uid","==",n.uid),G("ts",">=",oe.fromDate(X)),ie("ts","desc")),Z=await ce(Y);let E=0;Z.docs.forEach(j=>{const N=j.data();N.type==="earn"&&(E+=Number(N.delta||0))});const R=Math.max(0,w.dailyEpCap-E);if(!Number.isFinite(y)||y<=0)g(null);else{const j=R<=0?0:Math.ceil(R/y),U=Math.min(j,100);g(Number.isFinite(U)?U:null)}}catch{g(null)}})()},[n,S]);const[A,q]=c.useState({}),[p,P]=c.useState([]),[ve,h]=c.useState(""),[H,L]=c.useState(!1),T=c.useCallback(async()=>{if(!n)return;h("");const e=await me(n.uid);z(Number(e.tree?.gpTotal||0)),b(Number(e.tree?.stage||1));try{const r=new Date().toLocaleDateString("en-CA"),i=e.tree||{};Number(i.stage||0)>=5&&Number(i.dailyGp||0)>0&&String(i.dailyDate||r)===r&&await ue(n.uid)}catch(r){h(r instanceof Error?r.message:"Failed to harvest")}const s={fertilizer:Number(e.inventory?.fertilizer||0),water:Number(e.inventory?.water||0),fertilizerActiveUntil:e.inventory?.fertilizerActiveUntil,waterActiveUntil:e.inventory?.waterActiveUntil};q(s);const o=await ge(n.uid);console.log("Recent economy logs count:",o.length,"logs"),console.log("Recent economy logs data:",o),P(o);try{console.log("Garden refresh: calling updateStageFromRecentActivity for user:",n.uid);const{stage:r,days:i}=await $(n.uid);console.log("Garden refresh: got stage and days:",{newStage:r,days:i}),b(r),M(i)}catch(r){h(r instanceof Error?r.message:"Failed to update activity")}},[n]);c.useEffect(()=>{T()},[T]);function W(e){if(!e)return"—";if(e instanceof Date)return e.toLocaleString();if(typeof e=="number")return new Date(e).toLocaleString();console.log("Garden data processing:",e,"toDate type:",typeof e.toDate);const s=e.toDate?.();return console.log("formatTs: toDate() 結果:",s),s?s.toLocaleString():"—"}function Q(e){if(e)return e instanceof Date?e:typeof e=="number"?new Date(e):e.toDate?.()}function C(e){if(!e)return!1;const s=e instanceof Date?e:typeof e=="number"?new Date(e):e.toDate?.()||void 0;return s?s.getTime()>Date.now():!1}return C(A.fertilizerActiveUntil),C(A.waterActiveUntil),t.jsxs("div",{className:"max-w-[960px] mx-auto px-4",children:[t.jsx("h2",{className:"h2 mb-3",children:a("nav.garden")}),!n&&t.jsxs("div",{className:"mb-4 p-4 rounded-[12px] border border-[var(--color-border,#e5e7eb)] bg-[var(--color-surface,#fff)]",role:"region","aria-label":a("auth.signIn"),children:[t.jsx("div",{className:"font-semibold mb-1",children:a("auth.pleaseSignIn")}),t.jsx("div",{className:"text-[var(--color-muted,#6b7280)]",children:a("auth.privacyNote")}),t.jsx("div",{className:"mt-3",children:t.jsx(f,{onClick:()=>{le()},children:a("auth.signIn")})})]}),!n&&t.jsx("div",{className:"text-[var(--color-muted,#6b7280)]",children:a("auth.privacyNote")}),!n&&t.jsx("div",{className:"h-4"}),n?t.jsxs("div",{children:[t.jsxs("div",{className:"flex gap-2 mb-3 flex-wrap",children:[t.jsx(f,{variant:u==="tree"?"primary":"outline",onClick:()=>D("tree"),children:a("garden.myTree")}),t.jsx(f,{variant:u==="history"?"primary":"outline",onClick:()=>D("history"),children:a("garden.history")})]}),u==="tree"&&t.jsxs("div",{children:[t.jsx("div",{className:"mb-3 grid place-items-center",children:(()=>{const e=typeof l=="number"&&l>=1&&l<=5?l:1,s=e>=5?"w-64 h-64":e>=3?"w-56 h-56":"w-48 h-48";return t.jsx("div",{className:`mx-auto translate-y-3 ${s}`,children:t.jsx(k,{stage:e,className:"w-full h-full"})})})()}),t.jsxs("div",{className:"mt-2 body muted",children:[a("garden.stage",{stage:l||1})," ",a("garden.maxStage")]}),t.jsxs("div",{className:"mt-3 p-3 rounded-[12px] bg-[var(--color-surface,#fff)] border border-[var(--color-border,#e5e7eb)] text-left",children:[t.jsx("div",{className:"font-semibold mb-1",children:a("garden.howToLevelUp")}),t.jsxs("ul",{className:"list-disc list-inside leading-7 text-[var(--color-muted,#6b7280)]",children:[t.jsx("li",{children:a("garden.levelUpRule1")}),t.jsx("li",{children:a("garden.levelUpRule2")}),t.jsx("li",{children:a("garden.levelUpRule3")})]}),(()=>{const e=Math.min(5,Math.max(1,Number(l)||1)+1),s=(Number(l)||1)<5,o=B||0;return s?t.jsx("div",{className:"mt-2 text-sm text-[var(--color-muted,#6b7280)]",children:a("garden.levelUpSuggestion",{needStage:e,moreMin:o.toFixed(0)})}):null})()]}),t.jsxs("div",{className:"mt-3 p-3 rounded-[12px] bg-[var(--color-surface,#fff)] border border-[var(--color-border,#e5e7eb)]",children:[t.jsx("div",{className:"font-semibold mb-2",children:a("garden.recentActivity")}),t.jsxs("div",{className:"grid grid-cols-5 gap-2 text-center",children:[m.map(e=>t.jsxs("div",{className:"p-2 rounded-[10px] border",children:[t.jsx("div",{className:"text-xs text-[var(--color-muted,#6b7280)]",children:e.date.slice(5)}),t.jsx("div",{className:`mt-1 font-semibold ${e.active?"text-[var(--color-success,#16a34a)]":"text-[var(--color-danger,#ef4444)]"}`,children:e.active?"✓":"✗"}),t.jsxs("div",{className:"text-xs text-[var(--color-muted,#6b7280)]",children:[e.minutes," min"]})]},e.date)),m.length===0&&t.jsx("div",{className:"col-span-5 text-[var(--color-muted,#6b7280)]",children:a("garden.noData")})]}),t.jsx("div",{className:"mt-2 text-sm text-[var(--color-muted,#6b7280)]",children:a("garden.activeDays",{activeDays:I,total:5})}),t.jsxs("div",{className:"mt-2 text-left",children:[t.jsx(f,{variant:"outline",onClick:async()=>{if(n){L(!0);try{const{stage:e,days:s}=await $(n.uid);b(e),M(s)}catch(e){h(e instanceof Error?e.message:"Failed")}finally{L(!1)}}},disabled:H,children:a("garden.recalculateActivity")}),t.jsx("div",{className:"mt-1 text-xs text-[var(--color-muted,#6b7280)]",children:a("garden.recalculateActivityTooltip")})]})]}),t.jsxs("div",{className:"mt-8",children:[t.jsx("div",{className:"h3 mb-2",children:a("garden.growthChartTitle")}),t.jsx("div",{className:"text-[var(--color-muted,#6b7280)] mb-3",children:a("garden.growthChartSubtitle")}),t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-5 gap-4 place-items-center",children:[1,2,3,4,5].map(e=>t.jsxs("div",{className:"w-full max-w-[200px] p-3 rounded-[12px] border border-[var(--color-border,#e5e7eb)] text-center",children:[t.jsx("div",{className:"mx-auto w-28 h-28",children:t.jsx(k,{stage:e,className:"w-full h-full"})}),t.jsx("div",{className:"mt-2 font-semibold",children:a("garden.stage",{stage:e})}),t.jsxs("div",{className:"text-sm text-[var(--color-muted,#6b7280)]",children:[e===1&&a("garden.stage1Desc"),e===2&&a("garden.stage2Desc"),e===3&&a("garden.stage3Desc"),e===4&&a("garden.stage4Desc"),e===5&&a("garden.stage5Desc")]})]},e))})]})]}),u==="history"&&t.jsxs("div",{children:[(()=>{const e=new Date().toLocaleDateString("en-CA");p.reduce((o,r)=>{const i=Q(r.ts);return(i?i.toLocaleDateString("en-CA"):"")===e&&r.type==="earn"?o+Number(r.delta||0):o},0);const s=m.find(o=>o.date===e);return s&&s.minutes,t.jsxs("div",{className:"mb-3 p-3 rounded-[12px] bg-[var(--color-surface,#fff)] border border-[var(--color-border,#e5e7eb)]",children:[t.jsxs("div",{className:"font-semibold mb-1",children:[a("garden.todaySummary"),t.jsx("span",{className:"inline-flex items-center",children:t.jsx("span",{className:"ml-1",children:t.jsx(de,{label:a("garden.pointsExplanation"),children:"?"})})})]}),t.jsx("div",{className:"text-[var(--color-muted,#6b7280)]",children:a("garden.todaySummary")})]})})(),t.jsxs("div",{className:"mb-3 p-3 rounded-[12px] bg-[var(--color-surface,#fff)] border border-[var(--color-border,#e5e7eb)] text-left",children:[t.jsx("div",{className:"font-semibold mb-1",children:a("garden.historyTitle")}),t.jsxs("ul",{className:"list-disc list-inside leading-7 text-[var(--color-muted,#6b7280)]",children:[t.jsx("li",{children:a("garden.historyRule1")}),t.jsx("li",{children:a("garden.historyRule2")})]})]}),t.jsx("div",{className:"text-[var(--color-muted,#6b7280)] mb-2",children:a("garden.recentLogs")}),t.jsxs("ul",{children:[p.map(e=>{const s=[],o=e.durationSec,r=e.accuracy,i=e.correctChars,d=e.totalQChars;if(typeof o=="number"&&s.push(`${o.toFixed(1)}min`),typeof r=="number"&&s.push(`${(r*100).toFixed(0)}%`),typeof i=="number"&&typeof d=="number"){const x=Math.min(i,d);s.push(`${x}/${d}${a("garden.charsUnit")}`)}const v=s.length?` ｜ ${s.join(" · ")}`:"";return t.jsxs("li",{className:"py-1.5 border-b border-[var(--color-border,#e5e7eb)]",children:[W(e.ts)," · +",Number(e.delta||0)," points (",e.source==="attempt"?"test":"other",") ",v]},e.id)}),p.length===0&&t.jsx("li",{className:"text-[var(--color-muted,#6b7280)]",children:a("garden.noLogs")})]})]})]}):null]})}export{be as default};
