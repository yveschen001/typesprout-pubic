import{u as L,a as E,b as q,c as I,r as l,d as P,e as k,g as H,j as s,T as D,L as R}from"./index-D4RQrBUQ.js";import{C as $,S as U,A as V}from"./ChartSection-x7vIRUtL.js";import{g as F,t as z}from"./index-eKjPdLg9.js";function B(e,r){if(e<60)return r("result.seconds",{count:Math.round(e)});const i=Math.floor(e/60),n=Math.round(e%60);if(i<60)return n>0?r("result.minutesSeconds",{minutes:i,seconds:n}):r("result.minutes",{count:i});const a=Math.floor(i/60),j=i%60;return j>0?r("result.hoursMinutes",{hours:a,minutes:j}):r("result.hours",{count:a})}function O(){const{t:e}=L(),{state:r}=E(),{lang:i}=q(),{user:n}=I(),[a,j]=l.useState({raw:r?.rawWpm??0,accuracy:r?.accuracy??0,adj:r?.adjWpm??0,dur:r?.durationSec??0,chars:r?.rawChars??0,totalQChars:Math.max(0,Number(r?.totalQChars||0))}),[N,y]=l.useState(null),[g,w]=l.useState(null),[C,S]=l.useState([]),[A,v]=l.useState([]),[M,_]=l.useState(!1);l.useEffect(()=>{(async()=>{try{if(!r?.fromTest&&!(a.raw>0||a.accuracy>0||a.adj>0)&&n){const u=P(k,"profiles",n.uid),c=(await H(u)).data()?.lastAttempt;c&&j({raw:Number(c.raw||0),accuracy:Number(c.accuracy||0),adj:Number(c.adjWpm||0),dur:Number(c.durationSec||0),chars:Number(c.rawChars||0),totalQChars:0})}}catch{}})()},[n,r?.fromTest,a.raw,a.accuracy,a.adj]),l.useEffect(()=>{(async()=>{try{const m=(await F({lang:i||"en-US",days:30,sampleLimit:500})).map(t=>Number(t.adjWpm||0)).filter(t=>Number.isFinite(t)).slice().sort((t,o)=>t-o),p=z(m,.2);if(y(p||0),m.length){const t=Number(r?.adjWpm??b)||0,x=m.filter(T=>T<t).length/m.length*100,h=Math.min(99.99,Math.max(.01,Number(x.toFixed(2))));w(Number.isFinite(h)?h:null)}else w(null)}catch{y(30)}})()},[i,r?.adjWpm,a.adj]),l.useEffect(()=>{(async()=>{try{let u=[];n&&(u=await F({uid:n.uid,days:30,sampleLimit:50}));const d=u.slice().reverse(),c=t=>{try{if(!t)return;if(t instanceof Date)return t;if(typeof t=="number")return new Date(t);if(typeof t=="object"&&t&&"toDate"in t){const o=t.toDate;return typeof o=="function"?o():void 0}}catch{}},m=d.map((t,o)=>({i:o,adj:Number(t.adjWpm||0),ts:c(t.ts),durationSec:Number(t.durationSec||0),rawChars:Number(t.rawChars||0),accuracy:Math.max(0,Math.min(1,Number(t.accuracy||0))),totalQChars:Array.isArray(t.questions)?t.questions.reduce((x,h)=>x+Number(h.chars||0),0):0})),p=d.map((t,o)=>({i:o,acc:Math.max(0,Math.min(1,Number(t.accuracy||0))),ts:c(t.ts),durationSec:Number(t.durationSec||0),rawChars:Number(t.rawChars||0),adj:Number(t.adjWpm||0),totalQChars:Array.isArray(t.questions)?t.questions.reduce((x,h)=>x+Number(h.chars||0),0):0}));Number.isFinite(a.adj)&&(a.adj||0)>=0&&m.push({i:m.length,adj:Number(a.adj||0),ts:new Date,durationSec:Number(a.dur||0),rawChars:Number(a.chars||0),accuracy:Math.max(0,Math.min(1,Number(a.accuracy||0))),totalQChars:Number(a.totalQChars||0)}),Number.isFinite(a.accuracy)&&(a.accuracy||0)>=0&&p.push({i:p.length,acc:Math.max(0,Math.min(1,Number(a.accuracy||0))),ts:new Date,durationSec:Number(a.dur||0),rawChars:Number(a.chars||0),adj:Number(a.adj||0),totalQChars:Number(a.totalQChars||0)}),S(m),v(p)}catch{S([]),v([])}})()},[n,a.adj,a.accuracy,a.dur,a.chars,a.totalQChars]);const f=a.accuracy,b=a.adj;a.chars;const Q=a.dur,W=a.totalQChars;return s.jsxs("div",{className:"max-w-[960px] mx-auto px-4",children:[s.jsx("h2",{className:"h2 mb-2",children:e("nav.result")}),s.jsxs("div",{className:"p-4 border rounded-[12px] shadow-[var(--elevation-card,0_1px_2px_rgba(0,0,0,.06),_0_2px_8px_rgba(0,0,0,.04))] text-left",children:[s.jsx("div",{className:"h3 mb-2",children:e("result.summary")}),s.jsxs("ul",{className:"list-disc list-inside space-y-1 pl-1 text-left",children:[s.jsx("li",{children:e("result.timeSpent",{time:Q>0?B(Q,e):"â€”"})}),s.jsx("li",{children:e("result.totalChars",{chars:W})}),s.jsx("li",{children:e("result.correctChars",{chars:Math.round(W*f)})}),s.jsxs("li",{className:"flex items-start gap-1",children:[s.jsx("span",{children:e("result.accuracy",{accuracy:(f*100).toFixed(0)})}),s.jsx(D,{label:e("result.accuracyTooltip"),children:"?"})]}),s.jsxs("li",{className:"flex items-start gap-1",children:[s.jsx("span",{children:e("result.adjWpm",{adjWpm:b.toFixed(1)})}),s.jsx(D,{label:e("result.scoreTooltip"),children:"?"})]}),N!=null&&s.jsx("li",{children:e("result.vsSiteAverage",{adjWpm:b.toFixed(1),siteAvg:N.toFixed(1),percentile:g!=null?` (${g}%)`:""})})]}),s.jsxs("div",{className:"mt-3 flex gap-3",children:[s.jsx(R,{to:`/${i}/test`,className:"inline-flex items-center gap-1 px-3 h-10 rounded-[10px] border",children:e("result.tryAgain")}),s.jsx("button",{className:"inline-flex items-center gap-1 px-3 h-10 rounded-[10px] border",onClick:()=>_(u=>!u),children:e(M?"result.hideInsights":"result.showInsights")})]})]}),M&&s.jsxs("div",{className:"mt-6","aria-describedby":"insights-desc",children:[s.jsx("div",{id:"insights-desc",className:"mb-2 text-[var(--color-muted,#6b7280)]",children:e("result.chartDescription")}),s.jsxs($,{topText:e("result.chartDescription"),children:[s.jsx(U,{data:C.length?C:Array.from({length:30},(u,d)=>({i:d,adj:b}))}),s.jsx("div",{className:"h-3"}),s.jsx(V,{data:A.length?A:Array.from({length:30},(u,d)=>({i:d,acc:f}))})]})]})]})}export{O as default};
