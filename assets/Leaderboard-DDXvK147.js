import{b as G,u as I,c as H,r as M,x as z,g as B,d as _,e as R,f as P,i as E,q as $,n as O,w as U,h as T,o as Z,j as a,T as J}from"./index-Dtk1fXa2.js";function K(L,i){const s=i.lang,x=s.startsWith("zh");console.log("filterAttempts: starting with",L.length,"attempts"),console.log("filterAttempts: opts",i);let t=L;return console.log("filterAttempts: after start",t.length),t=t.filter(o=>o.lang===s),console.log("filterAttempts: after lang filter",t.length,"lang:",s),t=t.filter(o=>{const d=Number(o.rawChars||0),u=Math.max(0,Math.floor(d*.05)),C=o.durationSec>=u&&o.accuracy>=0&&o.accuracy<=1;return C||console.log("filterAttempts: filtered out by duration/accuracy:",{durationSec:o.durationSec,accuracy:o.accuracy,minRequiredSec:u,uid:o.uid}),C}),console.log("filterAttempts: after duration/accuracy filter",t.length),t=t.filter(o=>{const d=x?o.cpm:o.rawWpm;if(!d)return console.log("filterAttempts: filtered out by missing raw speed:",{cpm:o.cpm,rawWpm:o.rawWpm,isZh:x,uid:o.uid}),!1;const u=x?d<=400:d<=200;return u||console.log("filterAttempts: filtered out by speed limit:",{raw:d,isZh:x,limit:x?400:200,uid:o.uid}),u}),console.log("filterAttempts: after speed filter",t.length),t=t.filter(o=>i.classCode?o.classCode===i.classCode:!0),console.log("filterAttempts: after classCode filter",t.length),t=t.filter(o=>{if(!i.gradeFilter)return!0;const d=i.uidToGrade?.[o.uid],u=typeof d=="number"?d===i.gradeFilter:!1;return u||console.log("filterAttempts: filtered out by grade:",{uid:o.uid,grade:d,gradeFilter:i.gradeFilter,uidToGrade:i.uidToGrade}),u}),console.log("filterAttempts: after grade filter",t.length),t}function Q(L,i=20,s="today"){const x=new Map,t=new Date;let o,d;if(s==="today"){const e=new Date(t.getFullYear(),t.getMonth(),t.getDate());o=e.toLocaleDateString("en-CA"),d=e.toLocaleDateString("en-CA")}else if(s==="yesterday"){const e=new Date(t.getTime()-864e5),p=new Date(e.getFullYear(),e.getMonth(),e.getDate());o=p.toLocaleDateString("en-CA"),d=p.toLocaleDateString("en-CA")}else if(s==="lastWeek"){const e=t.getDay(),p=e===0?6:e-1,j=new Date(t.getTime()-p*24*60*60*1e3),y=new Date(j.getTime()-10080*60*1e3),N=new Date(y.getTime()+8640*60*1e3);o=y.toLocaleDateString("en-CA"),d=N.toLocaleDateString("en-CA")}else{const e=new Date(t.getFullYear(),t.getMonth()-1,1),p=new Date(t.getFullYear(),t.getMonth(),0);o=e.toLocaleDateString("en-CA"),d=p.toLocaleDateString("en-CA")}console.log("toTopN: processing period",s,"from",o,"to",d),console.log("toTopN: total attempts to process",L.length);let u=0;L.forEach(e=>{const y=(D=>{if(!D)return new Date(0);const W=D;return typeof W?.toDate=="function"?W.toDate():D instanceof Date?D:typeof D=="number"||typeof D=="string"?new Date(D):new Date(0)})(e.ts).toLocaleDateString("en-CA");if(y<o||y>d){console.log("toTopN: skipping attempt from",y,"not in range",o,"to",d);return}u++;const N=e.uid;x.has(N)||x.set(N,{uid:N,totalDuration:0,totalChars:0,avgAccuracy:0,maxAdjWpm:0,attempts:[]});const w=x.get(N);w.totalDuration+=e.durationSec||0,w.totalChars+=e.rawChars||0,w.avgAccuracy+=e.accuracy||0,w.maxAdjWpm=Math.max(w.maxAdjWpm,e.adjWpm||0),w.attempts.push(e)}),x.forEach(e=>{e.attempts.length>0&&(e.avgAccuracy=e.avgAccuracy/e.attempts.length)}),console.log("toTopN: processed attempts",u,"unique users",x.size);const C=Array.from(x.values()).map(e=>{const p=Math.min(e.totalDuration/60,2),j=e.maxAdjWpm*e.avgAccuracy*p;return{uid:e.uid,score:j,totalDuration:e.totalDuration,totalChars:e.totalChars,avgAccuracy:e.avgAccuracy,maxAdjWpm:e.maxAdjWpm,attempts:e.attempts}});return C.sort((e,p)=>p.score-e.score),console.log("toTopN: user merge results:",{totalUsers:C.length,topUsers:C.slice(0,5).map(e=>({uid:e.uid,score:e.score,totalDuration:e.totalDuration,maxAdjWpm:e.maxAdjWpm,avgAccuracy:e.avgAccuracy}))}),C.slice(0,i).map(e=>({...e.attempts.reduce((j,y)=>(y.adjWpm||0)>(j.adjWpm||0)?y:j),totalDuration:e.totalDuration,totalChars:e.totalChars,avgAccuracy:e.avgAccuracy,maxAdjWpm:e.maxAdjWpm,mergedScore:e.score}))}function X(){const{lang:L}=G(),i=L||"en-US",{t:s}=I(),{user:x}=H(),[t,o]=M.useState("today"),[d,u]=M.useState([]),[C,e]=M.useState(!0),[p,j]=M.useState(""),[y,N]=M.useState(void 0),[w,D]=M.useState(""),[W,q]=z();M.useEffect(()=>{const n=Number(W.get("grade")||"");N(Number.isFinite(n)&&n>0?n:void 0),D(W.get("class")||"")},[W]);const Y=M.useCallback(async()=>{e(!0),j("");try{const f=await(async()=>{try{const c=`${t}_${i}`,b=await B(_(R,"leaderboards",c)),m=b.exists()?b.data()?.rows:null;if(Array.isArray(m)&&m.length)return m;const g=P(R,"leaderboards",c,"rows");try{const h=(await E($(g,O(200)))).docs.map(l=>({id:l.id,...l.data()}));if(h.length)return h}catch{}const S=P(R,"leaderboards");try{const h=(await E($(S,U("period","==",t),U("lang","==",i),O(200)))).docs.map(l=>({id:l.id,...l.data()}));if(h.length)return h}catch{}}catch{}return null})();if(f&&f.length){const c=r=>Number(r.maxAdjWpm??r.score??r.adjWpm??0),b=r=>{const h=Number(r.avgAccuracy??r.accuracy??0);return Number.isFinite(h)?h:0},m=r=>Number(r.totalChars??r.rawChars??0);let g=f.slice();w&&(g=g.filter(r=>(r.classCode||r.scopeId||"").includes(w))),y&&(g=g.filter(r=>Number(r.grade||0)===y)),g.sort((r,h)=>c(h)-c(r));const S=g.slice(0,20).map((r,h)=>({id:r.id||`${r.uid||h}`,uid:r.uid,nick:r.nick,photoURL:r.photoURL,maxAdjWpm:c(r),avgAccuracy:b(r),totalChars:m(r)}));u(S);return}try{const c=`/leaderboards/${t}_${i}.json?ts=${Date.now()}`,b=await fetch(c);if(b.ok){const m=await b.json(),g=Array.isArray(m)?m:Array.isArray(m?.rows)?m.rows:[];if(g.length){const S=r=>Number(r.maxAdjWpm??r.score??r.adjWpm??0);g.sort((r,h)=>S(h)-S(r)),u(g.slice(0,20));return}}}catch{}try{const c=new Date;let b,m;if(t==="today"){const l=new Date(c.getFullYear(),c.getMonth(),c.getDate()),A=new Date(l.getTime()+1440*60*1e3);b=T.fromDate(l),m=T.fromDate(A)}else if(t==="yesterday"){const l=new Date(c.getTime()-864e5),A=new Date(l.getFullYear(),l.getMonth(),l.getDate()),F=new Date(A.getTime()+1440*60*1e3);b=T.fromDate(A),m=T.fromDate(F)}else if(t==="lastWeek"){const l=c.getDay(),A=l===0?6:l-1,F=new Date(c.getTime()-A*864e5),v=new Date(F.getTime()-7*864e5),k=new Date(v.getTime()+7*864e5);b=T.fromDate(new Date(Date.UTC(v.getFullYear(),v.getMonth(),v.getDate(),0,0,0))),m=T.fromDate(new Date(Date.UTC(k.getFullYear(),k.getMonth(),k.getDate(),0,0,0)))}else{const l=new Date(c.getFullYear(),c.getMonth()-1,1),A=new Date(c.getFullYear(),c.getMonth(),1);b=T.fromDate(new Date(Date.UTC(l.getFullYear(),l.getMonth(),l.getDate(),0,0,0))),m=T.fromDate(new Date(Date.UTC(A.getFullYear(),A.getMonth(),A.getDate(),0,0,0)))}const g=[U("lang","==",i),U("ts",">=",b)];m&&g.push(U("ts","<",m)),g.push(Z("ts","desc")),g.push(O(1e3));const S=$(P(R,"attempts"),...g),h=(await E(S)).docs.map(l=>({id:l.id,...l.data()}));if(h.length){const l=K(h,{lang:i,classCode:w||void 0}),F=Q(l,1e3,t).slice(0,20).map((v,k)=>({id:`${v.uid}-${k}`,uid:v.uid,nick:v.nick,photoURL:v.photoURL,maxAdjWpm:v.maxAdjWpm,avgAccuracy:v.avgAccuracy,totalChars:v.totalChars}));u(F);return}}catch{}u([])}catch(n){console.error("Failed to fetch leaderboard data:",n),j("Failed to load leaderboard data"),u([])}finally{e(!1)}},[i,t,y,w]);return M.useEffect(()=>{Y()},[Y,W]),a.jsxs("div",{className:"max-w-[960px] mx-auto px-4",children:[a.jsx("h2",{className:"h2 mb-3",children:s("nav.leaderboard")}),!x&&a.jsx("div",{className:"mb-3 text-[12px] text-[var(--color-muted,#6b7280)]",children:s("leaderboard.signInHint")}),C&&a.jsxs("div",{className:"text-center py-8",children:[a.jsx("p",{className:"text-gray-600 mb-4",children:s("leaderboard.loading")}),a.jsx("p",{className:"text-sm text-gray-500",children:s("leaderboard.loadingHint")})]}),p&&a.jsxs("div",{className:"text-center py-8",children:[a.jsx("p",{className:"text-red-600 mb-4",children:p}),a.jsx("button",{onClick:()=>Y(),className:"px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:s("leaderboard.reload")})]}),a.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-3 rounded-[12px] border p-2 bg-gradient-to-b from-emerald-50/30 to-white",children:[a.jsxs("select",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",value:t,onChange:n=>o(n.target.value),children:[a.jsx("option",{value:"today",children:s("leaderboard.today")}),a.jsx("option",{value:"yesterday",children:s("leaderboard.yesterday")}),a.jsx("option",{value:"lastWeek",children:s("leaderboard.lastWeek")}),a.jsx("option",{value:"lastMonth",children:s("leaderboard.lastMonth")})]}),a.jsxs("select",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",value:String(y||""),onChange:n=>{const f=Number(n.target.value||"");N(Number.isFinite(f)&&f>0?f:void 0);const c=new URLSearchParams(W);f?c.set("grade",String(f)):c.delete("grade"),q(c)},children:[a.jsx("option",{value:"",children:s("leaderboard.allGrades")}),a.jsx("option",{value:"1",children:s("leaderboard.grade",{grade:1})}),a.jsx("option",{value:"2",children:s("leaderboard.grade",{grade:2})}),a.jsx("option",{value:"3",children:s("leaderboard.grade",{grade:3})}),a.jsx("option",{value:"4",children:s("leaderboard.grade",{grade:4})}),a.jsx("option",{value:"5",children:s("leaderboard.grade",{grade:5})}),a.jsx("option",{value:"6",children:s("leaderboard.grade",{grade:6})})]}),a.jsx("input",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",placeholder:s("leaderboard.classCodePlaceholder"),value:w,onChange:n=>{D(n.target.value);const f=new URLSearchParams(W);n.target.value?f.set("class",n.target.value):f.delete("class"),q(f)}}),a.jsx("div",{className:"flex items-center gap-2 text-sm text-[var(--color-muted,#6b7280)]",children:a.jsx(J,{label:s("leaderboard.tooltip")})})]}),a.jsx("div",{className:"body muted mb-2",children:s("leaderboard.sortHint")}),a.jsxs("ol",{className:"space-y-2",tabIndex:0,"aria-label":"Leaderboard list",children:[d.map((n,f)=>a.jsxs("li",{className:"flex items-center justify-between rounded-[12px] border px-3 py-2",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"grid place-items-center w-8 h-8 rounded-full bg-[var(--color-primary,#16a34a)]/10 text-[var(--color-primary,#16a34a)] font-semibold",children:f+1}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("img",{src:n.photoURL||"https://lh3.googleusercontent.com/a/default-user=s32",alt:"avatar",className:"w-8 h-8 rounded-full object-cover",referrerPolicy:"no-referrer"}),a.jsx("div",{className:"font-medium",children:n.nick||(n.uid?n.uid.slice(0,6):"user")})]})]}),a.jsxs("div",{className:"text-right",children:[a.jsx("div",{className:"tabular-nums text-lg font-semibold",children:Number(n.maxAdjWpm||n.adjWpm).toFixed(1)}),typeof n.totalChars=="number"&&typeof n.avgAccuracy=="number"&&a.jsx("div",{className:"text-xs text-[var(--color-muted,#6b7280)]",children:s("leaderboard.stats",{chars:n.totalChars,accuracy:Math.round(n.avgAccuracy*100)})})]})]},n.id)),d.length===0&&a.jsx("div",{className:"text-[var(--color-muted,#6b7280)]",children:s("leaderboard.noData")})]})]})}export{X as default};
