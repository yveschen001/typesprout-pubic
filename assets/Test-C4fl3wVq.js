const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Result-PRfR8jEa.js","assets/index-Dtk1fXa2.js","assets/index-C6EMue_y.css","assets/ChartSection-DkycSL4D.js","assets/index-BPmxfEGk.js"])))=>i.map(i=>d[i]);
import{j as s,r as e,f as _t,e as _,q as ce,w as Dt,o as ie,n as _e,i as le,H as es,d as z,g as vt,t as ft,m as mt,h as Ue,u as xs,y as Ss,b as bs,c as ws,_ as Xe,k as ke,I as vs,J as Ms,B as re}from"./index-Dtk1fXa2.js";import{C as Ns,S as Cs,A as js}from"./ChartSection-DkycSL4D.js";import{h as Ts}from"./api-G5qA_UV0.js";import{u as Rs,a as De}from"./useQuestionBank-DJH-uY8J.js";import{d as As}from"./debug-CNNn05X7.js";import{g as Es}from"./index-BPmxfEGk.js";import"./env-DauFzF5H.js";const ne={stages:{s2:100,s3:300,s4:700,s5:1200}};function ks({percent:n,label:d,color:i,striped:T}){const p=Math.max(0,Math.min(100,n)),N=i||"var(--color-primary,#16a34a)",E=T?{backgroundImage:"repeating-linear-gradient(45deg, rgba(255,255,255,.25) 0, rgba(255,255,255,.25) 10px, transparent 10px, transparent 20px)"}:void 0;return s.jsx("div",{"aria-label":d||"progress","aria-valuemin":0,"aria-valuemax":100,"aria-valuenow":Math.round(p),role:"progressbar",className:"h-2 bg-[var(--color-border,#e5e7eb)] rounded-lg",children:s.jsx("div",{className:"h-2 rounded-lg",style:{width:`${p}%`,background:N,...E||{}}})})}function Ds(){const n=e.useRef(new Map),d="typesprout_keystats_v1";function i(){try{const m=localStorage.getItem(d);if(!m)return{};const c=JSON.parse(m);return c&&typeof c=="object"?c:{}}catch{return{}}}function T(m){try{localStorage.setItem(d,JSON.stringify(m))}catch{}}function p(m){const c=n.current.get(m)||{hits:0,misses:0,sumLatencyMs:0};c.lastDownAt=performance.now(),n.current.set(m,c)}function N(m,c){const x=n.current.get(m)||{hits:0,misses:0,sumLatencyMs:0};c?x.hits+=1:x.misses+=1,x.lastDownAt&&(x.sumLatencyMs+=performance.now()-x.lastDownAt),x.lastDownAt=void 0,n.current.set(m,x)}return e.useMemo(()=>({onKeyDown:p,onKeyUp:N,getErrRateByKey:m=>{const c=n.current.get(m),x=(c?.hits||0)+(c?.misses||0);return x>0?c.misses/x:0},getLatencyZ:m=>{let c=0,x=0;n.current.forEach(F=>{F.hits+F.misses>0&&(c+=F.sumLatencyMs/Math.max(1,F.hits+F.misses),x++)});const R=x>0?c/x:1,L=n.current.get(m);return((L&&L.hits+L.misses>0?L.sumLatencyMs/Math.max(1,L.hits+L.misses):R)-R)/(R||1)},persistSnapshot:()=>{const m=i();n.current.forEach((c,x)=>{const R=m[x]||{hits:0,misses:0};R.hits+=c.hits,R.misses+=c.misses,m[x]=R}),T(m)},getAggregatedErrMap:()=>{const m=i(),c={};return new Set([...Object.keys(m),...Array.from(n.current.keys())]).forEach(R=>{const L=m[R]||{hits:0,misses:0},C=n.current.get(R)||{hits:0,misses:0},F=L.hits+C.hits,P=L.misses+C.misses,$=F+P;c[R]=$>0?P/$:0}),c},dump:()=>n.current}),[])}const ae=50;async function _s(n){try{const d=_t(_,"attempts"),i=ce(d,Dt("uid","==",n),ie("ts","desc"),_e(ae+10)),p=(await le(i)).docs;if(p.length>ae){const N=p.slice(ae),E=es(_);N.forEach(m=>{E.delete(m.ref)}),await E.commit(),console.log(`Deleted ${N.length} old records, keeping user ${n} within ${ae} records limit`)}}catch(d){console.error("Error limiting user records:",d)}}async function Us(n){await _s(n)}function Is(n,d,i){return Math.max(d,Math.min(i,n))}function oe(n=Date.now()){const d=new Date(n),i=d.getFullYear(),T=`${d.getMonth()+1}`.padStart(2,"0"),p=`${d.getDate()}`.padStart(2,"0");return`${i}-${T}-${p}`}async function Ls(n){try{const d=oe(),i=new Date(d+"T00:00:00");console.log("Gamification engine: Getting today earned",{uid:n,today:d,start:i.toISOString()});try{const T=ce(_t(_,"economyLogs"),Dt("uid","==",n),Dt("ts",">=",Ue.fromDate(i)),ie("ts","desc"),_e(200)),p=await le(T);let N=0;return p.docs.forEach(E=>{const m=E.data();m.type==="earn"&&m.source==="attempt"&&(N+=Number(m.delta||0))}),console.log("Economy logs found:",{count:p.docs.length,sum:N}),N}catch(T){console.warn("Composite query failed, falling back to simple query:",T);const p=ce(_t(_,"economyLogs"),Dt("uid","==",n),ie("ts","desc"),_e(200)),N=await le(p);let E=0;const m=new Date(d+"T00:00:00");return N.docs.forEach(c=>{const x=c.data();(x.ts?.toDate?.()||new Date(x.ts))>=m&&x.type==="earn"&&x.source==="attempt"&&(E+=Number(x.delta||0))}),console.log("Simple query results:",{count:N.docs.length,sum:E}),E}}catch(d){return console.error("Error in getTodayAttemptEp:",d),0}}async function Ye(n){const{uid:d,lang:i,durationSec:T,raw:p,adj:N,accuracy:E,correctChars:m,totalChars:c,totalQChars:x}=n;console.log("Applying attempt rewards:",{uid:d,lang:i,durationSec:T,raw:p,adj:N,accuracy:E,correctChars:m,totalChars:c,totalQChars:x});const R=Math.max(T,1)/60,L=["en-US","zh-TW","zh-CN"].includes(i)?i:"en-US",C=ft.baseByLang[L],F=await Ls(d),P=Math.max(0,ft.dailyEpCap-F),$=z(_,"profiles",d),Mt=await vt($),Ut=Mt.exists()?Mt.data():{},It=Number(Ut.grade||3),V=ft.targetByGrade[L]?.[It]||20,$t=C*R*Is(N/V,0,2)*(.5+.5*E);let A=Math.round($t);const pt=E>=.3?Math.floor(T/10):0;A=Math.max(A,pt),A<=0&&T>=30&&E>=.5&&(A=1);const K=Math.min(P,Math.max(0,A)),Gt=z(_,"inventory",d),Nt=await vt(Gt),Z=Nt.exists()?Nt.data():{},Ct=Date.now(),jt=Z.fertilizerActiveUntil?.toMillis?Z.fertilizerActiveUntil.toMillis():Number(Z.fertilizerActiveUntil||0),Wt=Z.waterActiveUntil?.toMillis?Z.waterActiveUntil.toMillis():Number(Z.waterActiveUntil||0),Lt=jt>Ct?1:0,qt=Wt>Ct?1:0,X=Math.floor(K*(1+.2*Lt+.1*qt)),ht=es(_),Ft=Number(Ut.points||0)+K,ue=Number(Ut.xp||0)+K;ht.set($,{points:Ft,xp:ue,updatedAt:mt()},{merge:!0});const nt=z(_,"trees",d),Tt=await vt(nt),Y=Tt.exists()?Tt.data():{},G=Number(Y.gpTotal||0)+X,at=oe(),ot=Y.dailyDate||at,de=Number(Y.dailyGp||0),B=ot===at?de+X:X;let Q=Y.stage||1;G>=ne.stages.s5?Q=5:G>=ne.stages.s4?Q=4:G>=ne.stages.s3?Q=3:G>=ne.stages.s2?Q=2:Q=1,Tt.exists()?ht.update(nt,{stage:Q,gpTotal:G,dailyGp:B,dailyDate:at,lastActiveDate:oe(),updatedAt:mt()}):ht.set(nt,{uid:d,seed:Math.floor(Math.random()*1e9),dna:{angle:22,branchVar:.3,leafHue:120,fruitHue:12},stage:Q,gpTotal:G,dailyGp:B,dailyDate:at,lastActiveDate:oe(),createdAt:mt(),updatedAt:mt()});const zt=_t(_,"economyLogs"),Jt={uid:d,ts:mt(),type:"earn",source:"attempt",delta:K,balanceAfter:Ft,durationSec:T,raw:p,adj:N,accuracy:E,correctChars:m,totalChars:c,totalQChars:x};console.log("Economy log data:",Jt),ht.set(z(zt),Jt),console.log("Committing batch transaction");try{await ht.commit(),console.log("Batch transaction committed successfully")}catch(Pt){throw console.error("Error committing batch transaction:",Pt),Pt}}function ts(n){let d=0;for(let i=0;i<n.length;i++)d=(d<<5)-d+n.charCodeAt(i),d|=0;return String(d)}function Gs(){const{t:n}=xs(),{currentBank:d}=Rs(),[i,T]=e.useState("Kids Typing & Tree Growth"),[p,N]=e.useState(""),[E,m]=e.useState(""),[c,x]=e.useState(!1),[R,L]=e.useState(5),[C,F]=e.useState([]),[P,$]=e.useState(0),[Mt,Ut]=e.useState(!0),[It]=e.useState("auto"),[V,$t]=e.useState(5);e.useEffect(()=>{[1,3,5].includes(V)||$t(5)},[V]);const A=e.useCallback(t=>Math.max(1e3,Math.floor(t.length*V*1e3)),[V]),[pt,K]=e.useState(0),[Gt,Nt]=e.useState([]),[Z,Ct]=e.useState([]),[jt,Wt]=e.useState(null),[Lt,qt]=e.useState(0),[X,ht]=e.useState(0),[Ft,ue]=e.useState(0),[nt,Tt]=e.useState(!1),[Y,G]=e.useState(""),at=e.useRef(null),ot=e.useRef(!1),[de,B]=e.useState(n("test.promptStart")),[Q,zt]=e.useState(!1),[Jt,Pt]=e.useState(!1),fe=Ss(),{lang:v}=bs(),{user:S}=ws(),[ss,Ie]=e.useState(!1),[Ht,Le]=e.useState(!1),[rs,me]=e.useState(!1),ct=Ds(),ns=e.useRef(""),Vt=e.useRef([]),it=e.useRef(0),pe=e.useRef(!1),he=e.useRef(""),ge=e.useRef(0),qe=e.useRef(1),Zt=e.useRef(!1),ye=e.useRef("typesprout_seen_ids"),xe=e.useRef([]),[Se,be]=e.useState(null),[as]=e.useState("exact"),[os,we]=e.useState(0),[cs,ve]=e.useState(0),[Fe,Xt]=e.useState([]),Me=e.useRef(0),Pe=e.useRef(0),tt=e.useRef(0),gt=e.useRef(!1),Rt=e.useRef(!1),is=e.useRef(0),Qe=e.useRef(!1),Ke=e.useRef(0),[Be,Oe]=e.useState(!1),Yt=e.useRef(0),lt=e.useRef(0),ls=e.useRef(0),yt=e.useRef(0),te=e.useRef(0),ee=e.useRef(""),Qt=e.useRef([]);e.useEffect(()=>{try{Xe(()=>import("./Result-PRfR8jEa.js"),__vite__mapDeps([0,1,2,3,4]))}catch{}},[]),e.useEffect(()=>{try{new URLSearchParams(window.location.search).get("e2e")==="1"&&L(1)}catch{}},[]),e.useEffect(()=>{(async()=>{try{if(!S){be(null),Oe(!0);return}const t=z(_,"profiles",S.uid),r=await vt(t),f=(r.exists()?r.data():void 0)?.grade,l=typeof f=="number"?f:Number(f??NaN);be(Number.isFinite(l)?Math.max(1,Math.min(6,l)):null)}catch{be(null)}finally{Oe(!0)}})()},[S]);async function $e(t){try{const r=new Date().toLocaleDateString("en-CA"),u=new Date(r+"T00:00:00"),f=ce(_t(_,"economyLogs"),Dt("uid","==",t),Dt("ts",">=",Ue.fromDate(u)),ie("ts","desc")),l=await le(f);let a=0;return l.docs.forEach(y=>{const k=y.data();k.type==="earn"&&k.source==="attempt"&&(a+=Number(k.delta||0))}),As("Test","getTodayEarned: 結果",{uid:t,sum:a,records:l.docs.length}),a}catch{return 0}}e.useEffect(()=>{Be&&(async()=>{const t=++Yt.current;Tt(!0),G("");try{let r=function(o){let j=0;for(let g=0;g<o.length;g++)j=(j<<5)-j+o.charCodeAt(g),j|=0;return String(j)};const u=`typesprout_qs_cache_${v||"en-US"}`;try{const o=JSON.parse(localStorage.getItem(u)||"[]");if(Array.isArray(o)&&o.length>0&&t===Yt.current){F(o),$(0);const j=o[0]||"Kids Typing & Tree Growth";T(j),N(""),m(""),B(n("test.promptStart"));const g=A(j);K(g),we(0),ve(0),Xt([]),Me.current=Date.now(),tt.current=0,lt.current=0,te.current=0,Qt.current=[],Ke.current=o.length,Rt.current=!1;const I=new Uint8Array(16);crypto.getRandomValues(I),ee.current=Array.from(I).map(et=>et.toString(16).padStart(2,"0")).join(""),it.current=0,yt.current=0}}catch{}const f=new AbortController,l=setTimeout(()=>f.abort(),1500);let a=null;try{const o=`typesprout_cursor_${v||"en-US"}`,j=Number(localStorage.getItem(o)||"0");let g=500,I=15;try{const rt=await(await fetch("/index.json",{signal:f.signal})).json();rt&&Number(rt.pageSize)&&(g=Math.max(1,Number(rt.pageSize))),rt&&rt.filesPerLang&&rt.filesPerLang[v||"en-US"]&&(I=Number(rt.filesPerLang[v||"en-US"]))}catch{}const et=Math.max(1,Math.floor(j/g)+1),st=Math.min(3,I),He=Math.max(1,et-1);console.log("[Test] Loading content with questionBankType:",d),a=await De({lang:v||"en-US",questionBankType:d,limit:g*st,startPage:He,pageCount:st,signal:f.signal}),console.log("[Test] Loaded items count:",a?.length||0),I>st&&setTimeout(()=>{const Ae=I-st,rt=He+st;De({lang:v||"en-US",questionBankType:d,limit:g*Ae,startPage:rt,pageCount:Ae,signal:void 0}).then(Ee=>{if(Ee&&Ee.length>0)try{const Ve=`typesprout_qs_cache_${v||"en-US"}`,ps=JSON.parse(localStorage.getItem(Ve)||"[]"),hs=Ee.map(Ze=>{const ys=Ze.structured;return String(ys?.q||Ze.text||"")}),gs=[...ps,...hs];localStorage.setItem(Ve,JSON.stringify(gs.slice(0,800)))}catch{}}).catch(()=>{})},100)}catch{a=null}finally{clearTimeout(l)}if(a||(a=[]),!a||!Array.isArray(a)||a.length===0){const o=(()=>{try{return localStorage.getItem("typesprout_last_content_source")||""}catch{return""}})();if(o==="local:lang-missing")G("Language not supported: en-US. Please try: en-US");else{const j=o.startsWith("remote")?"Remote content failed":"Local content failed";G(`Content loading failed: ${j}`)}F([]),$(0),T("Kids Typing & Tree Growth");return}let y=a;if(Se!=null){const o=Se,j=Math.max(1,o-1),g=Math.min(6,o+1);y=a.filter(I=>{const et=Number(I.grade_min??NaN),st=Number(I.grade_max??NaN);return!Number.isFinite(et)||!Number.isFinite(st)?!0:!(st<j||et>g)})}const k="typesprout_seen_ids",D=new Set(JSON.parse(localStorage.getItem(k)||"[]"));let q=new Set;try{if(S){const o=z(_,"profiles",S.uid),j=await vt(o),g=j.data(),I=j.exists()&&Array.isArray(g?.lastSeenIds)?g?.lastSeenIds:[];q=new Set(I)}}catch{}const W=new Set([...Array.from(D),...Array.from(q)]);y=y.filter(o=>typeof o.id=="string"&&!W.has(String(o.id)));const bt=y.map(o=>{const g=o.structured?.q||(typeof o.text=="string"?o.text:"Kids Typing & Tree Growth");return{id:typeof o.id=="string"&&o.id.length?o.id:r(g),text:g}}),dt=new Set,b=[];for(const o of bt)dt.has(o.id)||(dt.add(o.id),b.push(o));let h=b;if(h.length===0&&a&&a.length){const o=a.map(g=>{const et=g.structured?.q||(typeof g.text=="string"?g.text:"Kids Typing & Tree Growth");return{id:typeof g.id=="string"&&g.id.length?g.id:r(et),text:et}}),j=new Set;h=[];for(const g of o)j.has(g.id)||(j.add(g.id),h.push(g))}const M=`typesprout_cursor_${v||"en-US"}`;let w=Number(localStorage.getItem(M)||"0");const U=h.length;if(S)try{const o=z(_,"profiles",S.uid),g=(await vt(o)).data();g?.lastCursorLang===(v||"en-US")&&typeof g?.lastCursor=="number"&&(w=g.lastCursor,console.log("Test: Ready to start"))}catch{}const Bt=W.size/Math.max(1,U)>.8;let wt=0;if(Bt){if(localStorage.setItem(M,"0"),localStorage.setItem(k,"[]"),S)try{await ke(z(_,"profiles",S.uid),{lastCursor:0,lastSeenIds:[]},{merge:!0})}catch{}console.log("Test: Content loaded successfully")}else wt=Number.isFinite(w)?Math.max(0,Math.min(w,Math.max(0,U-1))):0;const O=[];for(let o=0;o<Math.min(R,U);o++)O.push(h[(wt+o)%U]);const H=(wt+Math.min(R,U))%Math.max(1,U),Ot=O.map(o=>o.id),Re=Array.from(new Set([...Array.from(W),...Ot]));he.current=M,ge.current=H,ye.current=k,xe.current=Re;const kt=O.map(o=>o.text);try{localStorage.setItem(u,JSON.stringify(kt))}catch{}if(t===Yt.current){F(kt),$(0);const o=kt[0]||"Kids Typing & Tree Growth";T(o),N(""),m(""),B(n("test.promptStart"));const j=A(o);K(j),we(0),ve(0),Xt([]),Me.current=Date.now(),tt.current=0,lt.current=0,te.current=0,Qt.current=[],Ke.current=kt.length,Rt.current=!1;const g=new Uint8Array(16);crypto.getRandomValues(g),ee.current=Array.from(g).map(I=>I.toString(16).padStart(2,"0")).join(""),it.current=0,yt.current=0}}catch{G("Failed to load content"),F([]),$(0),T("Kids Typing & Tree Growth")}finally{t===Yt.current&&Tt(!1)}})()},[v,R,Se,as,S,Be,A]),e.useEffect(()=>{!c&&i&&K(A(i))},[V,i,c,A]),e.useEffect(()=>{c&&!ut.current&&i&&Ht&&(yt.current=performance.now(),Kt.current=performance.now(),K(A(i)),ut.current=!0,console.log("Test: Questions loaded"))},[c,i,Ht,A,P]),e.useEffect(()=>{if(!c){me(!1);return}if(Ht){me(!1);return}const t=setTimeout(()=>me(!0),1e3);return()=>clearTimeout(t)},[c,Ht]),e.useEffect(()=>{c&&(Q||Rt.current||pt<=0&&!gt.current&&(ut.current=!1,setTimeout(()=>{gt.current||Te.current()},0)))},[pt,c,Q]);const Ne=e.useMemo(()=>{let t=0;for(let r=0;r<p.length&&r<i.length;r++)p[r]===i[r]&&t++;return t},[p,i]),J=cs+Ne;console.log("Test: Component mounted");const Ge=e.useMemo(()=>Math.max(Lt/1e3,.01)/60,[Lt]),xt=e.useMemo(()=>It==="zh"||It==="auto"&&(v||"en-US").startsWith("zh"),[It,v]),Ce=e.useMemo(()=>(C||[]).reduce((t,r)=>t+(r?.length||0),0),[C]),St=e.useMemo(()=>Ce>0?J/Ce:0,[Ce,J]),We=xt?J/Ge:J/5/Ge,ze=e.useMemo(()=>We,[We]),us=e.useMemo(()=>Math.max(0,Math.ceil(pt/10)/100).toFixed(2),[pt]),je=e.useMemo(()=>nt||Y||!i||i.length===0||(C?.length||0)<=0?!1:A(i)>0,[nt,Y,i,C,A]),ut=e.useRef(!1),Kt=e.useRef(null);e.useEffect(()=>{c&&at.current?.focus()},[c]);function ds(t){if(t.key==="Enter"){if(t.preventDefault(),Date.now()-Pe.current<300){B("Please wait a moment");return}if(ot.current){B("Please finish typing");return}if(p.length===0){B("Please type something");return}C.length-1,At()}}const At=e.useCallback(()=>{if(Rt.current||gt.current)return;gt.current=!0;const t=p.length===0?"x":p,r=it.current;for(let b=r;b<t.length;b++){const h=t[b]||"",M=i[b]||"",w=h.length===1?h.toUpperCase():h;ct.onKeyUp(w,h===M)}it.current=t.length;const u=Math.max(0,i.length-p.length);console.log("Test: Input changed"),lt.current+=p.length,console.log("Test: Typing progress updated"),ls.current+=u,we(b=>b+p.length+u),ve(b=>b+Ne);const f=Math.max(0,Math.round(yt.current>0?performance.now()-yt.current:0)),l=p.length,y=xt?1.2:1,k=Math.round(Math.max(200,l*60*y)),D=f<k,q=ts(i),W=ts(ee.current+"|"+q+"|"+String(l)+"|"+String(f));Qt.current.push({qid:q,chars:l,spentMs:f,mistakes:tt.current,fastViolation:D,tokenSig:W}),!D&&l>0?(te.current+=f,ht(b=>b+f),ue(b=>b+l),console.log("Test: Question processing")):console.log("t('ui.loading')"),u>0&&(tt.current+=u);const bt={text:i,allowed:Math.floor(A(i)/1e3),spent:Math.floor((l>0?f:0)/1e3),mistakes:tt.current};Xt(b=>[...b,bt]);try{ct.persistSnapshot()}catch{}B("Time is up!");const dt=()=>{if(P<C.length-1){const b=P+1;is.current+=1,$(b);const h=C[b]||"Kids Typing & Tree Growth";T(h),N(""),m(""),K(A(h)),B(""),ut.current=!1,tt.current=0,it.current=0;const M=performance.now();Wt(M),qt(0),Kt.current=M,ut.current=!0,yt.current=M}else{Rt.current=!0,x(!1),zt(!0),B(n("test.promptFinished"));try{console.log("Test: 自動保存測驗結果"),setTimeout(()=>{Je.current().then(()=>{console.log("Test component mounted");try{const O=C.reduce((Re,kt)=>Re+(kt?.length||0),0),H=Math.floor(O*50),Ot=Math.max(0,X)>=H;S&&Ot&&Ts(S.uid).catch(()=>{})}catch{}}).catch(O=>{console.error("Error persisting attempt:",O)})},0);const b=lt.current>0||Qt.current.some(O=>O.chars>0),h=b?Math.max(1,X):0,M=h/6e4,w=b?lt.current:0,U=b&&M>0?xt?w/M:w/5/M:0,Et=b?St:0,Bt=U*Et,wt=C.reduce((O,H)=>O+(H?.length||0),0);Qe.current||(Qe.current=!0,setTimeout(()=>{fe(`/${v}/result`,{state:{rawWpm:U,accuracy:Et,adjWpm:Bt,durationSec:Number((h/1e3).toFixed(2)),rawChars:w,totalQChars:wt,fromTest:!0}})},100))}catch{}}};setTimeout(()=>{dt(),gt.current=!1},200)},[St,xt,ct,v,fe,P,C,i,A,p,Ne,n,Lt,X]),Te=e.useRef(At);e.useEffect(()=>{Te.current=At},[At]),e.useEffect(()=>{if(!c||Q||Rt.current||!ut.current||!jt)return;let t=0;const r=u=>{const f=Kt.current??u,l=u-f;Kt.current=u,jt&&qt(y=>y+l);let a=!1;if(K(y=>{const k=y-l;return k<=0?(a=!0,0):k}),a&&!gt.current){ut.current=!1,requestAnimationFrame(()=>{gt.current||Te.current()});return}t=requestAnimationFrame(r)};return t=requestAnimationFrame(r),()=>cancelAnimationFrame(t)},[c,Q,jt]),e.useEffect(()=>{(async()=>{try{if(!S){Nt([]),Ct([]);return}const r=(await Es({uid:S.uid,days:30,sampleLimit:200})).slice().reverse(),u=a=>{if(!a)return;if(a instanceof Date)return a;if(typeof a=="number")return new Date(a);const y=a;return typeof y.toDate=="function"?y.toDate():void 0},f=r.map((a,y)=>({i:y,adj:Number(a.adjWpm||0),ts:u(a.ts),durationSec:Number(a.durationSec||0),rawChars:Number(a.rawChars||0),accuracy:Math.max(0,Math.min(1,Number(a.accuracy||0))),totalQChars:Number(a.totalQChars||0)})),l=r.map((a,y)=>({i:y,acc:Math.max(0,Math.min(1,Number(a.accuracy||0))),ts:u(a.ts),durationSec:Number(a.durationSec||0),rawChars:Number(a.rawChars||0),accuracy:Math.max(0,Math.min(1,Number(a.accuracy||0))),totalQChars:Number(a.totalQChars||0)}));Nt(f),Ct(l)}catch{Nt([]),Ct([])}})()},[S]),e.useEffect(()=>{if(!C||C.length===0)return;if(Math.max(0,C.length-1-P)<=10&&!Zt.current){Zt.current=!0;try{const u=v||"en-US",f=Math.max(1,qe.current);De({lang:u,questionBankType:d,limit:200,startPage:f,pageCount:1,signal:void 0}).then(l=>{if(!(!l||!l.length)){try{const a=`typesprout_qs_cache_${u}`,k=[...JSON.parse(localStorage.getItem(a)||"[]"),...l.map(D=>String(D.structured?.q||D.text||""))];localStorage.setItem(a,JSON.stringify(k.slice(0,1e3)))}catch(a){console.warn("Failed to load page size from index.json:",a)}qe.current=f+1}}).finally(()=>{Zt.current=!1})}catch{Zt.current=!1}}},[P,C,v]);const se=e.useCallback(async()=>{try{if(!S)return;const t=xt,r=Ft,u=Math.max(1,X),f=u/6e4,l=t?r/f:r/5/f,a=St,y=l*a;if(r/Math.max(1,u/1e3)*60>ft.humanMaxCpm||!t&&l>200||t&&l>400)return;const D={uid:S.uid,ts:Ue.now(),lang:v||"en-US",mode:"test-perchar",durationSec:Number((u/1e3).toFixed(2)),rawChars:r,correctChars:J,accuracy:Number(a.toFixed(4)),adjWpm:Number(y.toFixed(2)),nick:S.displayName||"",createdAt:mt(),sessionToken:ee.current,totalInputMs:Math.round(u),totalChars:r,totalQChars:C.reduce((h,M)=>h+(M?.length||0),0),questions:Qt.current};try{const h=z(_,"profiles",S.uid),w=(await vt(h)).data(),U=typeof w?.classCode=="string"?w.classCode:void 0;U&&(D.classCode=String(U))}catch{}try{const h=ct.dump(),M={};h.forEach((w,U)=>{(w.hits||0)+(w.misses||0)>0&&(M[U]={h:w.hits||0,m:w.misses||0})}),D.keystats=M}catch{}t?D.cpm=Number(l.toFixed(2)):D.rawWpm=Number(l.toFixed(2));const q=await $e(S.uid);try{await Us(S.uid)}catch(h){console.warn("Error getting today earned:",h)}const W=C.reduce((h,M)=>h+(M?.length||0),0),bt=r*50,dt=W*50,b=Math.max(bt,dt);if(u<b){console.log(`[Test] Below dynamic threshold: need >= ${b}ms (typed=${bt}ms, question=${dt}ms), got ${u}ms → skip write/EP`);return}console.log("[AttemptDebug] metrics",{effectiveMs:u,effectiveChars:r,totalQCharsFromQuestions:W,minMsByTyped:bt,minMsByQuestion:dt,requiredMs:b,payload:{totalInputMs:D.totalInputMs,totalChars:D.totalChars}});try{await vs(_t(_,"attempts"),D)}catch{try{await Ye({uid:S.uid,lang:v||"en-US",durationSec:Number((u/1e3).toFixed(2)),raw:l,adj:y,accuracy:a,correctChars:J,totalChars:r,totalQChars:W})}catch{}return}console.log("Test attempt data:",{uid:S.uid,lang:v||"en-US",durationSec:Number((u/1e3).toFixed(2)),raw:l,adj:y,accuracy:a,correctChars:J,totalChars:r,totalQChars:W});try{await Ye({uid:S.uid,lang:v||"en-US",durationSec:Number((u/1e3).toFixed(2)),raw:l,adj:y,accuracy:a,correctChars:J,totalChars:r,totalQChars:W}),console.log("Attempt rewards applied successfully")}catch{}try{let h=await $e(S.uid);h<q&&(h=q);let M=Math.max(0,Math.round(h-q));if(M<=0){const U=v||"en-US",Et=ft.baseByLang[U],Bt=Math.max(u/1e3,1)/60,wt=ft.targetByGrade[U]?.[3]||20,O=Et*Bt*Math.max(0,Math.min(2,y/wt))*(.5+.5*a);let H=Math.round(O);H<=0&&(u/1e3>=30&&a>=.5||u/1e3>=5&&a>=.3)&&(H=1);const Ot=Math.max(0,ft.dailyEpCap-q);M=Math.max(0,Math.min(Ot,H)),h=Math.min(ft.dailyEpCap,q+M)}const w=document.createElement("div");w.role="status",w.setAttribute("aria-live","polite"),w.textContent="Loading questions...",w.style.position="fixed",w.style.right="16px",w.style.bottom="16px",w.style.background="#111827",w.style.color="#fff",w.style.padding="8px 12px",w.style.borderRadius="8px",w.style.boxShadow="0 2px 8px rgba(0,0,0,.2)",document.body.appendChild(w),setTimeout(()=>{try{document.body.removeChild(w)}catch{}},1600)}catch{}try{const h=z(_,"profiles",S.uid);await ke(h,{attemptsCount:Ms(1),lastAttempt:{ts:mt(),lang:v||"en-US",durationSec:Number((u/1e3).toFixed(2)),rawChars:r,correctChars:J,accuracy:Number(a.toFixed(4)),adjWpm:Number(y.toFixed(2)),metric:t?"cpm":"wpm",raw:Number(l.toFixed(2))},updatedAt:mt()},{merge:!0})}catch{}}catch{}},[S,v,xt,St,ct,J,X,Ft]),Je=e.useRef(se);e.useEffect(()=>{Je.current=se},[se]);const fs=pt/1e3<=10&&c;function ms(){const t=[];for(let r=0;r<i.length;r++){const u=i[r];let f="";r<p.length?f=p[r]===u?"text-[var(--color-success)]":"text-[var(--color-danger)] underline decoration-[var(--color-danger)]":r===p.length&&c?f="bg-sky-100 border-b-2 border-sky-400":f="text-[var(--color-muted,#6b7280)]",t.push(s.jsx("span",{className:f,children:u},r))}return s.jsx("p",{className:"font-mono typing-text break-words",children:t})}return s.jsxs("div",{className:"max-w-[960px] mx-auto px-4",children:[s.jsx("h2",{className:"h2 mb-3",children:n("test.title")}),s.jsxs("div",{className:"flex flex-wrap items-center gap-3","aria-keyshortcuts":"Space R F Enter",children:[s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("span",{children:n("test.questionCount")}),s.jsxs("select",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",value:R,onChange:t=>L(parseInt(t.target.value)),children:[s.jsx("option",{value:5,children:"5"}),s.jsx("option",{value:10,children:"10"}),s.jsx("option",{value:20,children:"20"}),s.jsx("option",{value:30,children:"30"}),s.jsx("option",{value:60,children:"60"})]})]}),s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("span",{children:n("test.difficulty")}),s.jsxs("select",{className:"h-11 rounded-[12px] border border-[var(--color-border,#e5e7eb)] px-3",value:V,onChange:t=>$t(parseInt(t.target.value)),children:[s.jsx("option",{value:1,children:n("test.difficultyHard")}),s.jsx("option",{value:3,children:n("test.difficultyMedium")}),s.jsx("option",{value:5,children:n("test.difficultyEasy")})]})]}),s.jsxs("label",{className:"flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",checked:Mt,onChange:t=>Ut(t.target.checked)})," ",n("test.allowBackspace")]}),ss&&s.jsx("div",{className:"ml-auto px-2 py-1 rounded bg-[var(--color-warning)] text-white",children:n("test.capsLock")})]}),nt&&s.jsx("div",{className:"mt-2 px-3 py-2 rounded bg-sky-50 text-sky-700 border border-sky-200",role:"status","aria-live":"polite",children:n("test.loadingQuestions")}),!!Y&&s.jsx("div",{className:"mt-2 px-3 py-2 rounded bg-red-50 text-red-600 border border-red-200",role:"alert","aria-live":"assertive",children:Y}),s.jsxs("div",{className:"mt-3 relative",children:[s.jsxs("div",{className:`absolute right-0 -top-2 font-bold tabular-nums ${fs?"text-[var(--color-danger,#ef4444)]":"text-[var(--color-surface-foreground,#111827)]"} text-2xl`,"aria-live":"polite",role:"status",children:[us,"s"]}),s.jsx("div",{className:"text-[var(--color-muted)] text-sm leading-[var(--lh-normal)] text-left",children:nt?n("test.loadingQuestions"):n("test.progress",{current:P+1,total:R})}),s.jsx(ks,{label:"progress",percent:p.length/i.length*100}),s.jsxs("div",{className:"mt-2",onCopy:t=>t.preventDefault(),onCut:t=>t.preventDefault(),onContextMenu:t=>t.preventDefault(),children:[s.jsx("div",{className:"text-[var(--color-muted)] text-sm leading-[var(--lh-normal)] mb-1",children:n("test.inputPrompt")}),s.jsx("div",{className:"select-none",draggable:!1,"aria-label":n("test.questionText"),children:ms()})]}),s.jsxs("div",{className:"mt-1",children:[s.jsxs("div",{className:"relative",children:[s.jsx("textarea",{ref:at,rows:4,value:E,readOnly:!c,"aria-disabled":!c,onBeforeInput:t=>{const r=t;c||r.preventDefault(),r.inputType==="insertFromPaste"&&r.preventDefault()},onDrop:t=>{t.preventDefault()},onFocus:()=>{if(Le(!0),c&&!jt){const t=performance.now();Wt(t),qt(0),Kt.current=t,K(A(i)),ut.current=!0,yt.current=t}},onBlur:()=>Le(!1),onKeyDown:t=>{if(!c){t.preventDefault(),B(n("test.promptBegin"));return}if(t.key==="Enter"){ds(t);return}Ie(t.getModifierState("CapsLock"));const r=t.key.length===1?t.key.toUpperCase():t.key;ns.current=r,ct.onKeyDown(r),ot.current&&Vt.current.push(r),!Mt&&(t.key==="Backspace"||t.key==="Delete")&&t.preventDefault()},onKeyUp:t=>{if(!c){t.preventDefault();return}if(Ie(t.getModifierState("CapsLock")),ot.current)return;const r=it.current;if(p.length>r){pe.current=!0;const f=r,l=p[f]||"",a=i[f]||"",y=l.length===1?l.toUpperCase():l;ct.onKeyUp(y,l===a),l!==a&&(tt.current+=1)}it.current=p.length},onCompositionStart:()=>{ot.current=!0,Vt.current=[]},onCompositionEnd:t=>{ot.current=!1;const r=t.target.value,f=p.length,l=r[f]||"",a=i[f]||"",y=l===a;for(const k of Vt.current)ct.onKeyUp(k,y);Vt.current=[],y||(tt.current+=1),it.current=r.length,m(r),c&&N(r),r.length>0&&(pe.current=!0)},onChange:t=>{const r=t.target.value;m(r),!(ot.current||!c)&&N(r)},className:"w-full p-3 border border-[var(--color-border,#e5e7eb)] rounded-[12px] font-mono min-h-[120px] focus:outline-none focus:ring-2 focus:ring-sky-400 typing-input"}),!c&&!Q&&s.jsx("div",{className:"absolute inset-0 bg-white/60 flex items-center justify-center rounded-[12px]",children:s.jsx(re,{disabled:!je,onClick:()=>{if(je){Pe.current=Date.now(),x(!0);try{const t=window.gtag;typeof t=="function"&&t("event","test_start",{lang:v||"en-US",bank:d?.id||d?.name||"default",questions:R,per_char_sec:V,allow_backspace:Mt,page_path:location.pathname+location.search})}catch{}try{he.current&&localStorage.setItem(he.current,String(ge.current))}catch{}try{ye.current&&localStorage.setItem(ye.current,JSON.stringify(xe.current))}catch{}try{S&&ke(z(_,"profiles",S.uid),{lastSeenIds:xe.current.slice(-1e3),lastCursor:ge.current,lastCursorLang:v||"en-US"},{merge:!0})}catch{}setTimeout(()=>{at.current?.focus()},0),Me.current=Date.now(),tt.current=0,pe.current=!1}},children:n("ui.start")})})]}),c&&s.jsx("div",{className:"mt-2 flex items-center gap-3",children:s.jsx(re,{onClick:()=>{try{const t=window.gtag;typeof t=="function"&&t("event","test_submit",{lang:v||"en-US",q_index:P,page_path:location.pathname+location.search})}catch{}At()},children:n("test.submitQuestion")})})]})]}),s.jsx("div",{"aria-live":"polite",className:"mt-2 body muted",children:de}),rs&&c&&s.jsx("div",{role:"status","aria-live":"polite",className:"mt-2 px-3 py-2 rounded bg-yellow-50 text-[var(--color-warning)] border border-yellow-200",children:n("test.outOfFocus")}),s.jsx("div",{className:"sticky bottom-0 bg-white py-3 mt-3 border-t border-[var(--color-border,#e5e7eb)]",children:s.jsx("div",{className:"flex items-center justify-end gap-3 flex-wrap",children:s.jsx("div",{className:"text-[var(--color-muted,#6b7280)] text-sm",children:n("test.shortcuts")})})}),Q&&s.jsxs("div",{style:{marginTop:12},children:[s.jsxs("div",{style:{display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"},children:[s.jsx("strong",{children:n("test.finished")}),s.jsx("span",{children:n("test.accuracyLabel",{accuracy:(St*100).toFixed(0)})}),s.jsx("span",{children:n("test.adjWpmLabel",{adjWpm:ze.toFixed(1)})}),s.jsx(re,{disabled:Jt||!S,onClick:async()=>{try{Pt(!0),await se();const t=lt.current>0,r=t?Math.max(1,te.current):0,u=r/6e4,f=t?lt.current:0,l=t?xt?f/u:f/5/u:0,a=t?St:0,y=l*a,k=C.reduce((D,q)=>D+(q?.length||0),0);fe(`/${v}/result`,{state:{rawWpm:l,accuracy:a,adjWpm:y,durationSec:Number((r/1e3).toFixed(2)),rawChars:f,totalQChars:k}});try{(await Xe(async()=>{const{markPracticedNow:D}=await import("./index-Dtk1fXa2.js").then(q=>q.ar);return{markPracticedNow:D}},__vite__mapDeps([1,2]))).markPracticedNow()}catch{}}finally{Pt(!1)}},children:n("test.submitAndReview")}),!S&&s.jsx("span",{className:"text-[var(--color-muted,#6b7280)]",children:n("test.signInToSave")}),s.jsx(re,{variant:"outline",onClick:()=>{N(""),m(""),zt(!1),B(n("test.promptStart")),$(0);const t=C[0]||"Kids Typing & Tree Growth";T(t),K(A(t)),x(!1),Xt([]),lt.current=0},children:n("test.tryAgain")})]}),Fe.length>0&&s.jsxs("div",{className:"mt-4",children:[s.jsx("div",{className:"mb-2 text-sm text-[var(--color-muted,#6b7280)]",children:n("test.questionStats")}),s.jsxs("table",{className:"w-full text-sm border-collapse",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"text-left border-b border-[var(--color-border,#e5e7eb)]",children:[s.jsx("th",{className:"py-1 pr-2",children:"#"}),s.jsx("th",{className:"py-1 pr-2",children:n("test.questionPreview")}),s.jsx("th",{className:"py-1 pr-2",children:n("test.timeSpent")}),s.jsx("th",{className:"py-1 pr-2",children:n("test.timeLimit")}),s.jsx("th",{className:"py-1 pr-2",children:n("test.mistakes")})]})}),s.jsx("tbody",{children:Fe.map((t,r)=>s.jsxs("tr",{className:"border-b border-[var(--color-border,#e5e7eb)]",children:[s.jsx("td",{className:"py-1 pr-2",children:r+1}),s.jsxs("td",{className:"py-1 pr-2",children:[t.text.slice(0,24),t.text.length>24?"…":""]}),s.jsxs("td",{className:"py-1 pr-2",children:[t.spent,"s"]}),s.jsxs("td",{className:"py-1 pr-2",children:[t.allowed,"s"]}),s.jsx("td",{className:"py-1 pr-2",children:t.mistakes})]},r))})]})]})]}),s.jsx("div",{className:"mt-6",children:s.jsxs("details",{children:[s.jsx("summary",{className:"cursor-pointer select-none",children:n("test.insightsSummary")}),s.jsx("div",{className:"mt-3 flex flex-wrap gap-6 items-start",children:s.jsxs(Ns,{topText:n("test.chartDescription"),children:[s.jsx(Cs,{data:Gt.length?Gt:Array.from({length:Math.min(30,Math.max(1,Math.floor((os+p.length)/10)))},(t,r)=>({i:r,adj:Math.max(0,Number((ze*(r+1)/30).toFixed(2)))}))}),s.jsx("div",{className:"h-3"}),s.jsx(js,{data:Z.length?Z:Array.from({length:30},(t,r)=>({i:r,acc:Math.max(0,Math.min(1,St))}))})]})})]})})]})}export{Gs as default};
